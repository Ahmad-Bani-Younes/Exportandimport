<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø¯ÙØªØ± Ø§Ù„ØµØ§Ø¯Ø±Ø§Øª ÙˆØ§Ù„ÙˆØ§Ø±Ø¯Ø§Øª â€” Ù…Ø­Ù„ Ø§Ù„Ø£Ø«Ø§Ø«</title>
  <meta name="color-scheme" content="dark light">
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --primary:#60a5fa; --accent:#34d399; --danger:#f87171; --warn:#fbbf24; --good:#22c55e; --border:#1f2937;
      --shadow:0 10px 24px rgba(0,0,0,.25);
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f8fafc; --panel:#ffffff; --muted:#64748b; --text:#0f172a; --border:#e2e8f0; --shadow:0 8px 20px rgba(0,0,0,.06); }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui, -apple-system, Segoe UI, Roboto, "Tajawal", Arial, sans-serif;
      background:var(--bg); color:var(--text);
    }

    header{position:sticky;top:0;background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,0)) , var(--panel);padding:14px;border-bottom:1px solid var(--border);backdrop-filter:saturate(120%) blur(6px);z-index:5}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .brand{display:flex;gap:12px;align-items:center}
    .brand h1{margin:0;font-size:clamp(20px,3.4vw,26px)}

    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}

    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
    .card .h{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .card .b{padding:16px}

    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    button, .btn{appearance:none;border:none;background:var(--primary);color:#fff;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;transition:.2s;display:inline-flex;align-items:center;gap:8px}
    button.secondary{background:transparent;color:var(--text);border:1px solid var(--border)}
    button.ghost{background:transparent;color:var(--muted)}
    button.danger{background:var(--danger)}
    button.good{background:var(--good)}
    button:disabled{opacity:.6;cursor:not-allowed}
    input, select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--text)}
    label{font-size:12px;color:var(--muted)}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}

    .chip{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 10px;border:1px solid var(--border);font-size:12px}
    .chip.in{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.3)}
    .chip.out{background:rgba(248,113,113,.12);border-color:rgba(248,113,113,.3)}

    .summary{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (max-width:640px){.summary{grid-template-columns:1fr}}
    .sum-card{padding:12px;border-radius:14px;border:1px solid var(--border);background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,0));display:flex;justify-content:space-between;align-items:center}
    .sum-card h3{margin:0;font-size:13px;color:var(--muted)}
    .sum-card .v{font-size:20px;font-weight:800}
    .sum-in .v{color:var(--good)}
    .sum-out .v{color:var(--danger)}
    .sum-net .v{color:var(--text)}

    .list{display:flex;flex-direction:column;gap:10px}
    .item{border:1px solid var(--border);border-radius:14px;padding:12px;display:grid;grid-template-columns:1fr auto;gap:8px}
    .item .meta{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .item .title{font-weight:800}
    .item .note{color:var(--muted);font-size:12px}
    .item .amt{font-weight:900}
    .item .act{display:flex;gap:6px}

    .empty{padding:24px;border:1px dashed var(--border);border-radius:14px;text-align:center;color:var(--muted)}

    .history{max-height:360px;overflow:auto}
    details{border:1px solid var(--border);border-radius:12px;background:rgba(255,255,255,.02)}
    details summary{cursor:pointer;padding:12px 14px;list-style:none}
    details[open]{background:rgba(255,255,255,.04)}

    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:rgba(148,163,184,.15);border:1px solid var(--border);padding:2px 6px;border-radius:6px;font-size:12px}
    .footer{margin:24px 0;color:var(--muted);font-size:12px}
    .dangerzone{display:flex;gap:8px;flex-wrap:wrap}

    /* Toast */
    .toast{position:fixed;inset-inline-start:50%;transform:translateX(-50%);bottom:18px;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:var(--shadow);z-index:60;font-weight:700;opacity:0;pointer-events:none;transition:.25s}
    .toast.show{opacity:1; pointer-events:auto}

    /* Ù…ØµØºÙ‘Ø±Ø§Øª Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª */
    .thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .thumb{width:64px;height:64px;border:1px solid var(--border);border-radius:8px;overflow:hidden;position:relative}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .thumb .x{position:absolute;top:2px;inset-inline-end:2px;background:rgba(0,0,0,.6);color:#fff;border:none;border-radius:6px;padding:2px 4px;cursor:pointer}

    /* Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© / PDF */
    #printContainer{display:none}
    @media print{
      @page{ size:A4 portrait; margin:12mm; }
      body{ background:#fff; color:#000 }
      header,.no-print{ display:none !important }
      #printContainer{ display:block !important }
      .report{ font-family:"Tajawal", Arial, sans-serif }
      .report h2, .report h3{ margin:0 0 8px }
      .report .head{ display:flex; justify-content:space-between; align-items:flex-start; gap:10px; margin-bottom:10px }
      .report .head .meta{ color:#333; font-size:12px }
      .report .chips{ display:flex; flex-wrap:wrap; gap:6px; margin:6px 0 12px }
      .report .chip{ border:1px solid #777; color:#000 }
      .print-table{ width:100%; border-collapse:collapse; }
      .print-table th,.print-table td{ border:1px solid #555; padding:6px 8px; font-size:12px; vertical-align:top }
      .print-table th{ background:#f2f2f2 }
      .report .foot{ display:flex; justify-content:space-between; margin-top:18px; font-size:12px }
      .report .sig{ min-width:160px; border-top:1px dashed #777; text-align:center; padding-top:6px }
      .p-cell-att{ display:flex; flex-wrap:wrap; gap:4px; align-items:flex-start }
      .p-thumb{ position:relative; width:60px; height:60px; border:1px solid #555; overflow:hidden }
      .p-thumb img{ width:100%; height:100%; object-fit:cover }
      .p-thumb span{ position:absolute; bottom:0; left:0; right:0; background:rgba(255,255,255,.85); color:#000; font-size:9px; text-align:center; line-height:1.2 }
    }
  </style>
</head>
<body>
  <header class="no-print">
    <div class="container brand">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M4 7h16M4 12h16M4 17h10" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
      </svg>
      <h1>Ø¯ÙØªØ± Ø§Ù„ØµØ§Ø¯Ø±Ø§Øª ÙˆØ§Ù„ÙˆØ§Ø±Ø¯Ø§Øª â€” Ù…Ø­Ù„ Ø§Ù„Ø£Ø«Ø§Ø«</h1>
    </div>
  </header>

  <div class="container no-print" id="app">

    <div class="grid">
      <!-- ÙŠØ³Ø§Ø±: Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ… -->
      <section class="card">
        <div class="h">
          <div class="controls">
            <button class="secondary" id="prevDay" title="Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø³Ø§Ø¨Ù‚">â—€</button>
            <input type="date" id="datePicker" />
            <button class="secondary" id="nextDay" title="Ø§Ù„ÙŠÙˆÙ… Ø§Ù„ØªØ§Ù„ÙŠ">â–¶</button>
            <button id="todayBtn" title="Ø§Ù„ÙŠÙˆÙ…">Ø§Ù„ÙŠÙˆÙ…</button>
            <span class="chip" id="weekday"></span>
          </div>
          <div class="controls">
            <button id="shareDay">ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ÙŠÙˆÙ…</button>
            <button class="good" id="pdfAll" title="ØªØµØ¯ÙŠØ± PDF Ù„Ù„ÙŠÙˆÙ… (Ø§Ù„ÙƒÙ„)">PDF Ø§Ù„ÙŠÙˆÙ…</button>
            <!-- Ø²Ø±Ù‘ÙŠ PDF Ù„Ù„ÙˆØ§Ø±Ø¯/Ø§Ù„ØµØ§Ø¯Ø± Ù…Ø®ÙÙŠÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹ -->
          </div>
        </div>
        <div class="b">
          <div class="summary" id="summary">
            <div class="sum-card sum-in"><h3>Ø§Ù„ÙˆØ§Ø±Ø¯Ø§Øª</h3><div class="v" id="sumIn">0.00 Ø¯.Ø£</div></div>
            <div class="sum-card sum-out"><h3>Ø§Ù„ØµØ§Ø¯Ø±Ø§Øª</h3><div class="v" id="sumOut">0.00 Ø¯.Ø£</div></div>
            <div class="sum-card sum-net"><h3>Ø§Ù„ØµØ§ÙÙŠ</h3><div class="v" id="sumNet">0.00 Ø¯.Ø£</div></div>
          </div>

          <h3 style="margin:18px 0 8px">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ©</h3>
          <form id="entryForm" class="row" autocomplete="off">
            <div class="col" style="grid-column: span 12; display:grid; grid-template-columns:repeat(12,1fr); gap:10px">
              <div style="grid-column: span 3">
                <label>Ø§Ù„Ù†ÙˆØ¹</label>
                <select id="type" required>
                  <option value="in">ÙˆØ§Ø±Ø¯ (Ø¯Ø®Ù„)</option>
                  <option value="out">ØµØ§Ø¯Ø± (Ù…ØµØ±ÙˆÙ)</option>
                </select>
              </div>
              <div style="grid-column: span 3">
                <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯.Ø£)</label>
                <input type="number" step="0.01" min="0" id="amount" placeholder="0.00" required />
              </div>
              <div style="grid-column: span 6">
                <label>Ø§Ù„Ø¹Ù†ØµØ±/Ø§Ù„Ø´Ø®Øµ</label>
                <input type="text" id="title" placeholder="Ù…Ø«Ø§Ù„: Ø·Ù‚Ù… ÙƒÙ†Ø¨Ø§ÙŠØ§Øª / Ø¯ÙØ¹Ø© Ù…Ù† Ø£Ø­Ù…Ø¯" required />
              </div>
              <div style="grid-column: span 6">
                <label>Ù…Ù„Ø§Ø­Ø¸Ø©</label>
                <input type="text" id="note" placeholder="ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" />
              </div>

              <!-- Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙÙ‚Ø· -->
              <div style="grid-column: span 12">
                <label>Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© (ØµÙˆØ±)</label>
                <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center">
                  <input type="file" id="files" accept="image/*" multiple />
                </div>
                <div id="filesPreview" class="thumbs"></div>
              </div>
            </div>
            <div class="col" style="grid-column: span 12; display:flex; gap:8px; margin-top:6px; align-items:center">
              <button type="submit">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ø¬Ù„</button>
              <span class="chip" title="ÙŠØ¤Ø®Ø° ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ø³Ø§Ø¹Ø© Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆØ§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø­Ø¯Ø¯">â±ï¸ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª ÙŠØªÙ…Ù‘Ø§Ù† ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</span>
            </div>
          </form>

          <h3 style="margin:22px 0 8px">Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ…</h3>
          <div id="dayList" class="list"></div>
        </div>
      </section>

      <!-- ÙŠÙ…ÙŠÙ†: Ø§Ù„Ø£Ø±Ø´ÙŠÙ -->
      <aside class="card">
        <div class="h">
          <div>Ø§Ù„Ø£Ø±Ø´ÙŠÙ â€” Ø­Ø³Ø¨ Ø§Ù„ÙŠÙˆÙ…</div>
          <div class="controls">
            <button class="secondary" id="expandAll">ÙØªØ­ Ø§Ù„ÙƒÙ„</button>
            <button class="secondary" id="collapseAll">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙƒÙ„</button>
          </div>
        </div>
        <div class="b history" id="history"></div>
        <div class="b">
          <div class="footer" style="margin-top:4px">
            ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ (LocalStorage + IndexedDB Ù„Ù„Ù…Ø±ÙÙ‚Ø§Øª).
          </div>
          <div style="margin-top:10px">
            <details>
              <summary>Ù…Ù†Ø·Ù‚Ø© Ø®Ø·Ø±Ø©</summary>
              <div class="dangerzone" style="margin-top:10px">
                <button class="danger" id="wipeAll">Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
              </div>
            </details>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© ØªØ­Ø±ÙŠØ± -->
  <dialog id="editDialog" class="no-print">
    <div class="dlg-h" style="padding:14px 16px;border-bottom:1px solid var(--border);font-weight:800">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</div>
    <div class="dlg-b" style="padding:16px">
      <form id="editForm" class="row">
        <input type="hidden" id="editId" />
        <input type="hidden" id="editDateKey" />
        <div style="grid-column: span 6">
          <label>Ø§Ù„Ù†ÙˆØ¹</label>
          <select id="editType" required>
            <option value="in">ÙˆØ§Ø±Ø¯ (Ø¯Ø®Ù„)</option>
            <option value="out">ØµØ§Ø¯Ø± (Ù…ØµØ±ÙˆÙ)</option>
          </select>
        </div>
        <div style="grid-column: span 6">
          <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯.Ø£)</label>
          <input type="number" step="0.01" min="0" id="editAmount" required />
        </div>
        <div style="grid-column: span 6">
          <label>Ø§Ù„Ø¹Ù†ØµØ±/Ø§Ù„Ø´Ø®Øµ</label>
          <input type="text" id="editTitle" required />
        </div>
        <div style="grid-column: span 6">
          <label>Ù…Ù„Ø§Ø­Ø¸Ø©</label>
          <input type="text" id="editNote" />
        </div>
        <div style="grid-column: span 6">
          <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
          <input type="date" id="editDate" required />
        </div>
        <div style="grid-column: span 6">
          <label>Ø§Ù„ÙˆÙ‚Øª</label>
          <input type="time" id="editTime" />
        </div>

        <!-- Ù…Ø±ÙÙ‚Ø§Øª ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
        <div style="grid-column: span 12">
          <label>Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label>
          <div id="editOldAtt" class="thumbs"></div>
        </div>
        <div style="grid-column: span 12">
          <label>Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙÙ‚Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</label>
          <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center">
            <input type="file" id="editFiles" accept="image/*" multiple />
          </div>
          <div id="editFilesPreview" class="thumbs"></div>
        </div>
      </form>
    </div>
    <div class="dlg-f" style="padding:12px 16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px">
      <button class="secondary" id="cancelEdit">Ø¥Ù„ØºØ§Ø¡</button>
      <button id="saveEdit">Ø­ÙØ¸</button>
    </div>
  </dialog>

  <!-- Ø­ÙˆØ§Ø± Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª -->
  <dialog id="attDialog" class="no-print">
    <div style="padding:12px 16px;border-bottom:1px solid var(--border);font-weight:800">Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©</div>
    <div id="attBody" style="padding:12px 16px;display:flex;flex-wrap:wrap;gap:10px"></div>
    <div style="padding:12px 16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px">
      <button class="secondary" id="attClose">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </dialog>

  <!-- Ù…Ù†Ø·Ù‚Ø© Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© / PDF -->
  <div id="printContainer" aria-hidden="true"></div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
(function(){
  const LS_KEY = 'furnitureLedgerV1';
  const currency = 'Ø¯.Ø£';

  // Ø¹Ù†Ø§ØµØ± DOM
  const datePicker = document.getElementById('datePicker');
  const weekdayEl = document.getElementById('weekday');
  const prevDayBtn = document.getElementById('prevDay');
  const nextDayBtn = document.getElementById('nextDay');
  const todayBtn = document.getElementById('todayBtn');
  const dayList = document.getElementById('dayList');
  const sumIn = document.getElementById('sumIn');
  const sumOut = document.getElementById('sumOut');
  const sumNet = document.getElementById('sumNet');
  const historyEl = document.getElementById('history');
  const shareDayBtn = document.getElementById('shareDay');

  const pdfAllBtn = document.getElementById('pdfAll');
  const pdfInBtn  = document.getElementById('pdfIn');   // Ù‚Ø¯ ÙŠÙƒÙˆÙ†Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ†
  const pdfOutBtn = document.getElementById('pdfOut');

  const expandAll = document.getElementById('expandAll');
  const collapseAll = document.getElementById('collapseAll');
  const wipeAll = document.getElementById('wipeAll');

  // Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
  const filesInput = document.getElementById('files');
  const filesPreview = document.getElementById('filesPreview');

  // Ø­ÙˆØ§Ø± Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
  const attDialog = document.getElementById('attDialog');
  const attBody = document.getElementById('attBody');
  const attClose = document.getElementById('attClose');

  // ÙÙˆØ±Ù… Ø§Ù„Ø¥Ø¶Ø§ÙØ© (Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ®/ÙˆÙ‚Øª)
  const form = document.getElementById('entryForm');
  const type = document.getElementById('type');
  const amount = document.getElementById('amount');
  const title = document.getElementById('title');
  const note = document.getElementById('note');

  // Ø­ÙˆØ§Ø± Ø§Ù„ØªØ­Ø±ÙŠØ±
  const editDialog = document.getElementById('editDialog');
  const editId = document.getElementById('editId');
  const editType = document.getElementById('editType');
  const editAmount = document.getElementById('editAmount');
  const editTitle = document.getElementById('editTitle');
  const editNote = document.getElementById('editNote');
  const editDate = document.getElementById('editDate');
  const editTime = document.getElementById('editTime');
  const editDateKey = document.getElementById('editDateKey');
  const editOldAtt = document.getElementById('editOldAtt');
  const editFiles = document.getElementById('editFiles');
  const editFilesPreview = document.getElementById('editFilesPreview');

  const printContainer = document.getElementById('printContainer');
  const toastEl = document.getElementById('toast');

  // ÙˆÙ‚Øª/ØªØ§Ø±ÙŠØ®
  const toKey = (d) => {
    const dt = new Date(d.getTime());
    dt.setHours(0,0,0,0);
    const y = dt.getFullYear();
    const m = String(dt.getMonth()+1).padStart(2,'0');
    const da = String(dt.getDate()).padStart(2,'0');
    return `${y}-${m}-${da}`;
  };
  const fromKey = (k) => { const [y,m,d] = k.split('-').map(Number); const dt = new Date(y, m-1, d); dt.setHours(0,0,0,0); return dt; };
  const weekdayName = (date) => new Intl.DateTimeFormat('ar-JO',{weekday:'long'}).format(date);
  const numFmt = new Intl.NumberFormat('ar-JO',{minimumFractionDigits:2, maximumFractionDigits:2});

  // ØªØ®Ø²ÙŠÙ†
  const load = () => { try{ return JSON.parse(localStorage.getItem(LS_KEY)) || { days:{} }; } catch{ return { days:{} }; } };
  const save = (data) => localStorage.setItem(LS_KEY, JSON.stringify(data));

  // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
  let state = load();
  let selected = toKey(new Date());

  // IndexedDB Ù„Ù„Ù…Ø±ÙÙ‚Ø§Øª
  const DB_NAME='furnitureLedgerDB', DB_VER=1;
  let dbPromise = initDB();
  async function initDB(){
    return new Promise((res,rej)=>{
      if(!('indexedDB' in window)){ res(null); return; }
      const req = indexedDB.open(DB_NAME, DB_VER);
      req.onupgradeneeded = ()=> {
        const db = req.result;
        if(!db.objectStoreNames.contains('attachments')){
          db.createObjectStore('attachments'); // key=id
        }
      };
      req.onsuccess = ()=> res(req.result);
      req.onerror   = ()=> rej(req.error);
    });
  }
  function txPut(db, store, key, val){ return new Promise((res,rej)=>{ const tx=db.transaction(store,'readwrite'); tx.objectStore(store).put(val,key); tx.oncomplete=res; tx.onerror=()=>rej(tx.error); }); }
  function txGet(db, store, key){ return new Promise((res,rej)=>{ const tx=db.transaction(store,'readonly'); const req=tx.objectStore(store).get(key); req.onsuccess=()=>res(req.result); req.onerror=()=>rej(req.error); }); }
  function txDel(db, store, key){ return new Promise((res,rej)=>{ const tx=db.transaction(store,'readwrite'); tx.objectStore(store).delete(key); tx.oncomplete=res; tx.onerror=()=>rej(tx.error); }); }
  async function putAttachment(blob){
    const id = 'att_' + cryptoRandomId();
    const db = await dbPromise;
    if(!db){ throw new Error('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¯Ø¹Ù… Ù„Ù„Ù…Ø±ÙÙ‚Ø§Øª'); }
    await txPut(db,'attachments', id, blob);
    return id;
  }
  async function getAttachment(id){
    const db = await dbPromise; if(!db) return null;
    return txGet(db,'attachments', id);
  }
  async function deleteAttachment(id){
    const db = await dbPromise; if(!db) return;
    return txDel(db,'attachments', id);
  }

  // ØªØ­ÙˆÙŠÙ„/Ø¶ØºØ· Ø§Ù„ØµÙˆØ±
  async function fileToImage(file){
    return new Promise((res,rej)=>{
      const fr = new FileReader();
      fr.onload = e=>{
        const img = new Image();
        img.onload = ()=> res(img);
        img.onerror = rej;
        img.src = e.target.result;
      };
      fr.onerror = rej;
      fr.readAsDataURL(file);
    });
  }
  function dataURLToBlob(dataURL){
    const parts = dataURL.split(','), mime = parts[0].match(/:(.*?);/)[1];
    const bin = atob(parts[1]); const len = bin.length; const u8 = new Uint8Array(len);
    for(let i=0;i<len;i++) u8[i]=bin.charCodeAt(i);
    return new Blob([u8], {type:mime});
  }
  async function compressImage(fileOrBlob, maxSide=1600, quality=0.9){
    const src = (fileOrBlob instanceof Blob && !(fileOrBlob instanceof File)) ? URL.createObjectURL(fileOrBlob) : null;
    const img = await (src ? new Promise((res,rej)=>{ const im=new Image(); im.onload=()=>res(im); im.onerror=rej; im.src=src; }) : fileToImage(fileOrBlob));
    const w = img.width, h = img.height, scale = Math.min(1, maxSide / Math.max(w, h));
    const canvas = document.createElement('canvas');
    canvas.width = Math.round(w * scale);
    canvas.height = Math.round(h * scale);
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    const blob = await new Promise(r=> canvas.toBlob(b=> r(b || dataURLToBlob(canvas.toDataURL('image/jpeg', quality))), 'image/jpeg', quality));
    if(src) URL.revokeObjectURL(src);
    return blob;
  }

  // Toast
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    setTimeout(()=> toastEl.classList.remove('show'), 1600);
  }

  // ØªØ§Ø±ÙŠØ® Ø§ÙØªØ±Ø§Ø¶ÙŠ
  const initDateControls = () => {
    datePicker.value = selected;
    weekdayEl.textContent = weekdayName(fromKey(selected));
  };

  // CRUD
  const addEntry = ({dateKey, kind, amount, title, note, time, attachments}) => {
    const id = cryptoRandomId();
    const createdAt = Date.now();
    if(!state.days[dateKey]) state.days[dateKey] = [];
    state.days[dateKey].push({ id, kind, amount, title, note, time, createdAt, attachments: attachments||[] });
    save(state);
  };
  const updateEntry = ({oldDateKey, id, dateKey, kind, amount, title, note, time, attachments}) => {
    const list = state.days[oldDateKey] || [];
    const idx = list.findIndex(x => x.id === id);
    if(idx === -1) return;
    const item = list[idx];
    const updated = { ...item, kind, amount, title, note, time, attachments: Array.isArray(attachments) ? attachments : (item.attachments||[]) };
    if(oldDateKey !== dateKey){
      list.splice(idx,1);
      if(!state.days[dateKey]) state.days[dateKey] = [];
      state.days[dateKey].push(updated);
      if(list.length === 0) delete state.days[oldDateKey];
    } else {
      list[idx] = updated;
    }
    save(state);
  };
  async function deleteEntry(dateKey, id){
    const list = state.days[dateKey] || [];
    const idx = list.findIndex(x => x.id === id);
    if(idx === -1) return;
    const [removed] = list.splice(idx,1);
    if(list.length === 0) delete state.days[dateKey];
    save(state);
    if(removed && removed.attachments){
      for(const aid of removed.attachments){ try{ await deleteAttachment(aid); }catch{} }
    }
  }

  function cryptoRandomId(){
    if(window.crypto && crypto.getRandomValues){
      const a = crypto.getRandomValues(new Uint32Array(4));
      return [...a].map(x=>x.toString(16).padStart(8,'0')).join('');
    }
    return Math.random().toString(16).slice(2)+Date.now().toString(16);
  }

  // Ø¹Ø±Ø¶ Ø§Ù„ÙŠÙˆÙ…
  const renderDay = (dateKey) => {
    const list = (state.days[dateKey] || []).slice().sort((a,b)=> a.createdAt - b.createdAt);
    dayList.innerHTML = '';
    if(list.length === 0){
      dayList.innerHTML = `<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ….</div>`;
    } else {
      list.forEach(item => {
        const row = document.createElement('div');
        row.className = 'item';
        row.dataset.id = item.id;
        row.dataset.dateKey = dateKey;
        const chipClass = item.kind === 'in' ? 'chip in' : 'chip out';
        const attCount = (item.attachments||[]).length;
        row.innerHTML = `
          <div>
            <div class="meta">
              <span class="${chipClass}">${item.kind === 'in' ? 'ÙˆØ§Ø±Ø¯' : 'ØµØ§Ø¯Ø±'}</span>
              <span class="chip">${item.time || '--:--'}</span>
              ${attCount ? `<span class="chip">ğŸ“ ${attCount} Ù…Ø±ÙÙ‚</span>` : ``}
            </div>
            <div class="title" style="margin-top:6px">${escapeHtml(item.title || '')}</div>
            <div class="note">${escapeHtml(item.note || '')}</div>
          </div>
          <div style="text-align:end">
            <div class="amt">${numFmt.format(Number(item.amount||0))} ${currency}</div>
            <div class="act" style="margin-top:8px">
              ${attCount ? `<button class="secondary" data-act="att">Ù…Ø±ÙÙ‚Ø§Øª</button>` : ``}
              <button class="secondary" data-act="edit">ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="danger" data-act="del">Ø­Ø°Ù</button>
            </div>
          </div>
        `;
        dayList.appendChild(row);
      });
    }
    const totalIn = list.filter(x=>x.kind==='in').reduce((s,x)=>s + Number(x.amount||0),0);
    const totalOut = list.filter(x=>x.kind==='out').reduce((s,x)=>s + Number(x.amount||0),0);
    sumIn.textContent = `${numFmt.format(totalIn)} ${currency}`;
    sumOut.textContent = `${numFmt.format(totalOut)} ${currency}`;
    sumNet.textContent = `${numFmt.format(totalIn - totalOut)} ${currency}`;
  };

  // Ø§Ù„Ø£Ø±Ø´ÙŠÙ
  const renderHistory = () => {
    const keys = Object.keys(state.days).sort((a,b)=> b.localeCompare(a));
    historyEl.innerHTML = '';
    if(keys.length === 0){
      historyEl.innerHTML = '<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯.</div>';
      return;
    }
    keys.forEach(k => {
      const list = state.days[k] || [];
      const totalIn = list.filter(x=>x.kind==='in').reduce((s,x)=>s + Number(x.amount||0),0);
      const totalOut = list.filter(x=>x.kind==='out').reduce((s,x)=>s + Number(x.amount||0),0);
      const net = totalIn - totalOut;

      const details = document.createElement('details');
      const dt = fromKey(k);
      details.innerHTML = `
        <summary>
          <strong>${k}</strong> â€” ${weekdayName(dt)}
          <span class="chip in" style="margin-inline:6px">ÙˆØ§Ø±Ø¯Ø§Øª: ${numFmt.format(totalIn)} ${currency}</span>
          <span class="chip out">ØµØ§Ø¯Ø±Ø§Øª: ${numFmt.format(totalOut)} ${currency}</span>
          <span class="chip" style="margin-inline:6px">Ø§Ù„ØµØ§ÙÙŠ: ${numFmt.format(net)} ${currency}</span>
          <span class="chip" data-go-day="${k}" title="ÙØªØ­ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…">Ø¹Ø±Ø¶</span>
        </summary>
        <div class="b" style="padding:12px 14px">
          ${(list||[]).map(it => `
            <div class="item" style="margin-bottom:8px">
              <div>
                <div class="meta">
                  <span class="${it.kind==='in'?'chip in':'chip out'}">${it.kind==='in'?'ÙˆØ§Ø±Ø¯':'ØµØ§Ø¯Ø±'}</span>
                  <span class="chip">${it.time || '--:--'}</span>
                  ${(it.attachments && it.attachments.length) ? `<span class="chip">ğŸ“ ${it.attachments.length} Ù…Ø±ÙÙ‚</span>` : ``}
                </div>
                <div class="title" style="margin-top:6px">${escapeHtml(it.title||'')}</div>
                <div class="note">${escapeHtml(it.note||'')}</div>
              </div>
              <div style="text-align:end">
                <div class="amt">${numFmt.format(Number(it.amount||0))} ${currency}</div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
      historyEl.appendChild(details);
    });
  };

  // Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø©
  function escapeHtml(str){ return String(str).replace(/[&<>"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s])); }

  // ****** Ù…Ø±ÙÙ‚Ø§Øª: Ø¥Ø¯Ø®Ø§Ù„ ÙˆÙ…Ø¹Ø§ÙŠÙ†Ø© ******
  let pendingAtt = []; // {blob, url}
  function addThumb(url, container, onRemove){
    const div=document.createElement('div'); div.className='thumb';
    div.innerHTML = `<img src="${url}" alt="ØµÙˆØ±Ø©"><button class="x" title="Ø¥Ø²Ø§Ù„Ø©">Ã—</button>`;
    div.querySelector('.x').onclick=()=>{
      onRemove?.();
      div.remove();
    };
    container.appendChild(div);
  }

  filesInput?.addEventListener('change', async ()=>{
    // ÙØ±Ù‘Øº Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    pendingAtt.forEach(p=>{ try{ URL.revokeObjectURL(p.url); }catch{} });
    pendingAtt=[]; filesPreview.innerHTML='';
    if(!filesInput.files || !filesInput.files.length) return;
    if(!('indexedDB' in window)){ toast('Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ù…Ø±ÙÙ‚Ø§ØªØ› ØªÙ… ØªØ¹Ø·ÙŠÙ„Ù‡Ø§'); filesInput.value=''; return; }
    const MAX_FILES = 6;
    let count = 0;
    for (const file of filesInput.files) {
      if(!file.type.startsWith('image/')) continue;
      if(count >= MAX_FILES){ toast('ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ø±ÙÙ‚Ø§Øª'); break; }
      try{
        const blob = await compressImage(file, 1600, 0.9);
        const url = URL.createObjectURL(blob);
        const idx = pendingAtt.length;
        pendingAtt.push({blob, url});
        addThumb(url, filesPreview, ()=>{
          URL.revokeObjectURL(pendingAtt[idx]?.url);
          pendingAtt[idx]=null;
        });
        count++;
      }catch{}
    }
    pendingAtt = pendingAtt.filter(Boolean);
  });

  // Ø£Ø­Ø¯Ø§Ø« Ø¹Ø§Ù…Ø© Ù„Ù„ØªÙ†Ù‚Ù„ Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®
  datePicker.addEventListener('change', () => {
    selected = datePicker.value || selected;
    weekdayEl.textContent = weekdayName(fromKey(selected));
    renderDay(selected);
  });
  prevDayBtn.addEventListener('click', ()=>{ moveSelected(-1); });
  nextDayBtn.addEventListener('click', ()=>{ moveSelected(+1); });
  todayBtn.addEventListener('click', ()=>{
    selected = toKey(new Date());
    datePicker.value = selected;
    weekdayEl.textContent = weekdayName(new Date());
    renderDay(selected);
  });
  function moveSelected(deltaDays){
    const d = fromKey(selected);
    d.setDate(d.getDate()+deltaDays);
    selected = toKey(d);
    datePicker.value = selected; weekdayEl.textContent = weekdayName(d); renderDay(selected);
  }

  // Ø­ÙØ¸ Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© (ØªØ§Ø±ÙŠØ®/ÙˆÙ‚Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙŠÙ†)
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const kind = type.value;
    const amt = Number(amount.value);
    const ttl = title.value.trim();
    const nt = (note.value||'').trim();

    if(!Number.isFinite(amt) || amt <= 0){ toast('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„ØºÙ‹Ø§ ØµØ­ÙŠØ­Ù‹Ø§ Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±'); return; }
    if(!ttl){ toast('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø© Ø£Ùˆ Ø§Ù„Ø´Ø®Øµ'); return; }

    // Ø§Ù„ØªØ§Ø±ÙŠØ® = Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
    const dtKey = selected;
    // Ø§Ù„ÙˆÙ‚Øª = Ø³Ø§Ø¹Ø© Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø¢Ù†
    const tm = new Date().toTimeString().slice(0,5);

    const attIds = [];
    if(pendingAtt.length){
      if(!('indexedDB' in window)){ toast('Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ù…Ø±ÙÙ‚Ø§ØªØ› ØªÙ… ØªØ¬Ø§Ù‡Ù„Ù‡Ø§'); }
      else {
        for(const p of pendingAtt){
          try{ const id = await putAttachment(p.blob); attIds.push(id); }
          catch{}
          finally{ URL.revokeObjectURL(p.url); }
        }
      }
      pendingAtt = []; filesInput.value=''; filesPreview.innerHTML='';
    }

    addEntry({dateKey: dtKey, kind, amount: amt, title: ttl, note: nt, time: tm, attachments: attIds});

    renderDay(selected);
    renderHistory();
    form.reset();
    amount.focus();
    toast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
  });

  // Ù†Ù‚Ø±Ø§Øª Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø³Ø¬Ù„
  dayList.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button');
    if(!btn) return;
    const act = btn.dataset.act;
    const row = btn.closest('.item');
    const id = row?.dataset.id;
    const dateKey = row?.dataset.dateKey;
    if(!id || !dateKey) return;

    if(act === 'del'){
      if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ')){
        await deleteEntry(dateKey, id);
        renderDay(selected);
        renderHistory();
        toast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
      }
    }
    if(act === 'edit'){
      openEditDialog(dateKey, id);
    }
    if(act === 'att'){
      const item = (state.days[dateKey]||[]).find(x=>x.id===id);
      openAttachments(item?.attachments || []);
    }
  });

  // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (ØªØ¨Ù‚Ù‰ Ù‚Ø§Ø¨Ù„Ø© Ù„ØªØºÙŠÙŠØ± Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª)
  let editPendingAtt = [];     
  let editDeleteIds  = new Set(); 
  let editOldUrlMap  = new Map(); 

  async function openEditDialog(dateKey, id){
    const item = (state.days[dateKey]||[]).find(x=>x.id===id);
    if(!item) return;
    editId.value = id;
    editDateKey.value = dateKey;
    editType.value = item.kind;
    editAmount.value = item.amount;
    editTitle.value = item.title || '';
    editNote.value = item.note || '';
    editDate.value = dateKey;
    editTime.value = item.time || '';

    cleanupEditDialog();

    const ids = item.attachments || [];
    for(const aid of ids){
      try{
        const blob = await getAttachment(aid);
        if(!blob) continue;
        const url = URL.createObjectURL(blob);
        editOldUrlMap.set(aid, url);
        const div=document.createElement('div'); div.className='thumb';
        div.innerHTML = `<img src="${url}" alt="Ù…Ø±ÙÙ‚"><button class="x" title="Ø­Ø°Ù">Ã—</button>`;
        div.querySelector('.x').onclick=()=>{
          editDeleteIds.add(aid);
          div.remove();
        };
        editOldAtt.appendChild(div);
      }catch{}
    }

    editDialog.showModal();
  }

  function cleanupEditDialog(){
    editOldUrlMap.forEach(url=> URL.revokeObjectURL(url));
    editOldUrlMap.clear();
    editPendingAtt.forEach(p=>{ try{ URL.revokeObjectURL(p.url); }catch{} });
    editPendingAtt = [];
    editDeleteIds.clear();
    editOldAtt.innerHTML = '';
    editFilesPreview.innerHTML = '';
    editFiles.value = '';
  }

  editFiles?.addEventListener('change', async ()=>{
    editFilesPreview.innerHTML='';
    editPendingAtt.forEach(p=>{ try{ URL.revokeObjectURL(p.url); }catch{} });
    editPendingAtt = [];
    if(!editFiles.files || !editFiles.files.length) return;
    if(!('indexedDB' in window)){ toast('Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª'); editFiles.value=''; return; }
    const MAX_FILES = 6;
    let count = 0;
    for (const file of editFiles.files) {
      if(!file.type.startsWith('image/')) continue;
      if(count >= MAX_FILES){ toast('ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ø±ÙÙ‚Ø§Øª'); break; }
      try{
        const blob = await compressImage(file, 1600, 0.9);
        const url = URL.createObjectURL(blob);
        const idx = editPendingAtt.length;
        editPendingAtt.push({blob, url});
        addThumb(url, editFilesPreview, ()=>{
          URL.revokeObjectURL(editPendingAtt[idx]?.url);
          editPendingAtt[idx]=null;
        });
        count++;
      }catch{}
    }
    editPendingAtt = editPendingAtt.filter(Boolean);
  });

  document.getElementById('cancelEdit').addEventListener('click', ()=>{
    cleanupEditDialog();
    editDialog.close();
  });

  document.getElementById('saveEdit').addEventListener('click', async ()=>{
    const id = editId.value;
    const oldDateKey = editDateKey.value;
    const newDateKey = editDate.value || oldDateKey;
    const kind = editType.value;
    const amt = Number(editAmount.value);
    const ttl = editTitle.value.trim();
    const nt = (editNote.value||'').trim();
    const tm = editTime.value || '--:--';

    if(!Number.isFinite(amt) || amt <= 0){ toast('Ø§Ù„Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ§Ù„Ø­'); return; }
    if(!ttl){ toast('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù†ØµØ±/Ø§Ù„Ø´Ø®Øµ'); return; }

    const curItem = (state.days[oldDateKey]||[]).find(x=>x.id===id) || {};
    const currentIds = Array.isArray(curItem.attachments) ? curItem.attachments.slice() : [];
    const keepIds = currentIds.filter(aid=> !editDeleteIds.has(aid));

    const newIds = [];
    for(const p of editPendingAtt){
      try{ const nid = await putAttachment(p.blob); newIds.push(nid); }catch{}
    }
    const finalAttachments = keepIds.concat(newIds);

    updateEntry({oldDateKey, id, dateKey:newDateKey, kind, amount:amt, title:ttl, note:nt, time:tm, attachments: finalAttachments});

    for(const aid of editDeleteIds){ try{ await deleteAttachment(aid); }catch{} }

    cleanupEditDialog();
    editDialog.close();

    if(newDateKey === selected || oldDateKey === selected){ renderDay(selected); }
    renderHistory();
    toast('ØªÙ… Ø§Ù„Ø­ÙØ¸');
  });

  // Ø§Ù„Ø£Ø±Ø´ÙŠÙ: ÙØªØ­ ÙŠÙˆÙ… Ù…Ø¹ÙŠÙ‘Ù†
  historyEl.addEventListener('click', (e)=>{
    const go = e.target.closest('[data-go-day]');
    if(go){
      selected = go.dataset.goDay;
      datePicker.value = selected;
      weekdayEl.textContent = weekdayName(fromKey(selected));
      renderDay(selected);
      window.scrollTo({top:0, behavior:'smooth'});
    }
  });

  // ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ ÙƒÙ„ Ø§Ù„Ø£ÙŠØ§Ù…
  expandAll.addEventListener('click', ()=>{ historyEl.querySelectorAll('details').forEach(d=> d.open = true); });
  collapseAll.addEventListener('click', ()=>{ historyEl.querySelectorAll('details').forEach(d=> d.open = false); });

  // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  wipeAll.addEventListener('click', async ()=>{
    if(confirm('ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')){
      try{
        const db = await dbPromise;
        if(db){
          const tx = db.transaction('attachments','readwrite');
          tx.objectStore('attachments').clear();
          await new Promise((r,_)=>{ tx.oncomplete=r; });
        }
      }catch{}
      state = { days:{} };
      save(state);
      renderDay(selected);
      renderHistory();
      toast('ØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    }
  });

  // PDF
  pdfAllBtn.addEventListener('click', ()=> exportPDF('all'));
  pdfInBtn?.addEventListener('click',  ()=> exportPDF('in'));
  pdfOutBtn?.addEventListener('click', ()=> exportPDF('out'));

  async function exportPDF(mode){
    const dateKey = selected;
    const listAll = (state.days[dateKey] || []).slice().sort((a,b)=> a.createdAt - b.createdAt);
    const list = mode==='all' ? listAll : listAll.filter(x=> x.kind === mode);
    if(list.length === 0){ toast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…'); return; }

    const ttlIn = listAll.filter(x=>x.kind==='in').reduce((s,x)=>s + Number(x.amount||0),0);
    const ttlOut = listAll.filter(x=>x.kind==='out').reduce((s,x)=>s + Number(x.amount||0),0);
    const netAll = ttlIn - ttlOut;
    const label = mode==='all' ? 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ… (Ø§Ù„ÙƒÙ„)' : (mode==='in' ? 'ØªÙ‚Ø±ÙŠØ± ÙˆØ§Ø±Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…' : 'ØªÙ‚Ø±ÙŠØ± ØµØ§Ø¯Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…');
    const oldTitle = document.title;
    document.title = `${label} - ${dateKey}`;

    const attUrlsForPrint = [];
    const rows = (await Promise.all(list.map(async (it, idx)=>{
      const rowNo = idx+1;
      const ids = it.attachments || [];
      const thumbs = [];
      for(const aid of ids){
        try{
          const blob = await getAttachment(aid);
          if(!blob) continue;
          const url = URL.createObjectURL(blob);
          attUrlsForPrint.push(url);
          thumbs.push(`<div class="p-thumb"><img src="${url}" alt="Ù…Ø±ÙÙ‚ ${rowNo}"><span>#${rowNo}</span></div>`);
        }catch{}
      }
      const attCell = thumbs.length ? `<div class="p-cell-att">${thumbs.join('')}</div>` : 'â€”';
      return `
        <tr>
          <td>${rowNo}</td>
          ${mode==='all' ? `<td>${it.kind==='in'?'ÙˆØ§Ø±Ø¯':'ØµØ§Ø¯Ø±'}</td>` : ``}
          <td>${escapeHtml(it.time || '--:--')}</td>
          <td>${escapeHtml(it.title || '')}</td>
          <td>${escapeHtml(it.note || '')}</td>
          <td style="text-align:left">${numFmt.format(Number(it.amount||0))} ${currency}</td>
          <td>${attCell}</td>
        </tr>
      `;
    }))).join('');

    const sumMode = list.reduce((s,x)=> s + Number(x.amount||0), 0);
    const tableCols = (mode==='all' ? 7 : 6);

    printContainer.innerHTML = `
      <div class="report">
        <div class="head">
          <div>
            <h2>Ù…Ø­Ù„ Ø§Ù„Ø£Ø«Ø§Ø«</h2>
            <h3>${label}</h3>
            <div class="meta">Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dateKey} â€” ${weekdayName(fromKey(dateKey))}</div>
          </div>
          <div class="meta">
            <div>ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${new Date().toLocaleString('ar-JO')}</div>
            <div>Ø§Ù„Ø¹Ù…Ù„Ø©: ${currency}</div>
          </div>
        </div>

        <div class="chips">
          <span class="chip">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙˆØ§Ø±Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…: <strong>${numFmt.format(ttlIn)}</strong> ${currency}</span>
          <span class="chip">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØµØ§Ø¯Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…: <strong>${numFmt.format(ttlOut)}</strong> ${currency}</span>
          <span class="chip">ØµØ§ÙÙŠ Ø§Ù„ÙŠÙˆÙ…: <strong>${numFmt.format(netAll)}</strong> ${currency}</span>
          ${mode!=='all' ? `<span class="chip">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${mode==='in'?'Ø§Ù„ÙˆØ§Ø±Ø¯Ø§Øª':'Ø§Ù„ØµØ§Ø¯Ø±Ø§Øª'} ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: <strong>${numFmt.format(sumMode)}</strong> ${currency}</span>` : ``}
        </div>

        <table class="print-table" aria-label="Ø¬Ø¯ÙˆÙ„ ØªÙ‚Ø±ÙŠØ± ${label}">
          <thead>
            <tr>
              <th>#</th>
              ${mode==='all' ? '<th>Ø§Ù„Ù†ÙˆØ¹</th>' : ''}
              <th>Ø§Ù„ÙˆÙ‚Øª</th>
              <th>Ø§Ù„Ø¹Ù†ØµØ±/Ø§Ù„Ø´Ø®Øµ</th>
              <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
              <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
              <th>Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
          <tfoot>
            <tr>
              <th colspan="${tableCols-1}" style="text-align:start">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
              <th style="text-align:left">${numFmt.format(sumMode)} ${currency}</th>
            </tr>
          </tfoot>
        </table>

        <div class="foot">
          <div class="sig">Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</div>
          <div class="sig">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
        </div>
      </div>
    `;

    const imgs = Array.from(printContainer.querySelectorAll('img'));
    if(imgs.length){
      try{
        await Promise.all(imgs.map(img => img.decode ? img.decode().catch(()=>{}) : new Promise(r=>{ img.onload=img.onerror=()=>r(); })));
      }catch{}
    }

    const after = ()=>{
      document.title = oldTitle;
      attUrlsForPrint.forEach(u=> URL.revokeObjectURL(u));
      window.removeEventListener('afterprint', after);
    };
    window.addEventListener('afterprint', after);
    setTimeout(()=> window.print(), 20);
  }

  // Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
  let attTempUrls = [];
  async function openAttachments(ids){
    attBody.innerHTML=''; attTempUrls.forEach(u=> URL.revokeObjectURL(u)); attTempUrls=[];
    if(!ids.length){ toast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª'); return; }
    for(const id of ids){
      try{
        const blob = await getAttachment(id);
        if(!blob) continue;
        const url = URL.createObjectURL(blob);
        attTempUrls.push(url);
        const a = document.createElement('a');
        a.href = url; a.target = '_blank'; a.rel="noopener";
        a.innerHTML = `<img src="${url}" alt="Ù…Ø±ÙÙ‚" style="width:140px;height:140px;object-fit:cover;border:1px solid var(--border);border-radius:8px" />`;
        attBody.appendChild(a);
      }catch{}
    }
    attDialog.showModal();
  }
  attClose?.addEventListener('click', ()=>{
    attDialog.close();
    attTempUrls.forEach(u=> URL.revokeObjectURL(u));
    attTempUrls=[];
  });

  // Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ÙŠÙˆÙ…
  function shareDay(){
    const dateKey = datePicker.value || selected;
    const items = (state.days[dateKey] || []).slice().sort((a,b)=> a.createdAt - b.createdAt);
    if(!items.length){ toast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ÙŠÙˆÙ…'); return; }

    let inSum=0, outSum=0;
    const lines = items.map((it,i)=>{
      const kind = it.kind==='in' ? 'â• ÙˆØ§Ø±Ø¯' : 'â– ØµØ§Ø¯Ø±';
      const amt  = `${numFmt.format(+it.amount||0)} ${currency}`;
      if(it.kind==='in') inSum += (+it.amount||0); else outSum += (+it.amount||0);
      const t = it.time || '--:--';
      const noteStr = it.note ? ` â€” ${it.note}` : '';
      return `${i+1}) ${kind} â€¢ ${amt} â€¢ ${t} â€¢ ${it.title||''}${noteStr}`;
    });

    const txt =
`ğŸ“… ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ… ${dateKey}

${lines.join('\n')}

Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ§Ø±Ø¯: ${numFmt.format(inSum)} ${currency}
Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµØ§Ø¯Ø±: ${numFmt.format(outSum)} ${currency}
Ø§Ù„ØµØ§ÙÙŠ: ${numFmt.format(inSum-outSum)} ${currency}`;

    if(navigator.clipboard){
      navigator.clipboard.writeText(txt).then(()=>toast('ğŸ“‹ ØªÙ… Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ±')).catch(()=>{});
    }
    if(navigator.share){
      navigator.share({text:txt}).catch(()=>{});
    }else{
      window.open('https://wa.me/?text='+encodeURIComponent(txt),'_blank');
    }
  }
  shareDayBtn?.addEventListener('click', shareDay);

  // ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ
  (function boot(){
    selected = toKey(new Date());
    initDateControls();
    renderDay(selected);
    renderHistory();
    if(!('indexedDB' in window)){
      filesInput?.setAttribute('disabled','');
    }
  })();

})(); // end IIFE
</script>
</body>
</html>
