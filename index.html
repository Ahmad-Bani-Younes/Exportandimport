<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>دفتر الصادرات والواردات — محل الأثاث</title>
  <meta name="color-scheme" content="dark light">
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --primary:#60a5fa; --accent:#34d399; --danger:#f87171; --warn:#fbbf24; --good:#22c55e; --border:#1f2937;
      --shadow:0 10px 24px rgba(0,0,0,.25);
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f8fafc; --panel:#ffffff; --muted:#64748b; --text:#0f172a; --border:#e2e8f0; --shadow:0 8px 20px rgba(0,0,0,.06); }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui, -apple-system, Segoe UI, Roboto, "Tajawal", Arial, sans-serif;
      background:var(--bg); color:var(--text);
    }

    header{position:sticky;top:0;background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,0)) , var(--panel);padding:14px;border-bottom:1px solid var(--border);backdrop-filter:saturate(120%) blur(6px);z-index:5}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .brand{display:flex;gap:12px;align-items:center}
    .brand h1{margin:0;font-size:clamp(20px,3.4vw,26px)}

    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}

    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
    .card .h{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .card .b{padding:16px}

    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    button, .btn{appearance:none;border:none;background:var(--primary);color:#fff;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;transition:.2s;display:inline-flex;align-items:center;gap:8px}
    button.secondary{background:transparent;color:var(--text);border:1px solid var(--border)}
    button.ghost{background:transparent;color:var(--muted)}
    button.danger{background:var(--danger)}
    button.good{background:var(--good)}
    button:disabled{opacity:.6;cursor:not-allowed}
    input, select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--text)}
    label{font-size:12px;color:var(--muted)}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}

    .chip{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 10px;border:1px solid var(--border);font-size:12px}
    .chip.in{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.3)}
    .chip.out{background:rgba(248,113,113,.12);border-color:rgba(248,113,113,.3)}

    .summary{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (max-width:640px){.summary{grid-template-columns:1fr}}
    .sum-card{padding:12px;border-radius:14px;border:1px solid var(--border);background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,0));display:flex;justify-content:space-between;align-items:center}
    .sum-card h3{margin:0;font-size:13px;color:var(--muted)}
    .sum-card .v{font-size:20px;font-weight:800}
    .sum-in .v{color:var(--good)}
    .sum-out .v{color:var(--danger)}
    .sum-net .v{color:var(--text)}

    .list{display:flex;flex-direction:column;gap:10px}
    .item{border:1px solid var(--border);border-radius:14px;padding:12px;display:grid;grid-template-columns:1fr auto;gap:8px}
    .item .meta{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .item .title{font-weight:800}
    .item .note{color:var(--muted);font-size:12px}
    .item .amt{font-weight:900}
    .item .act{display:flex;gap:6px}

    .empty{padding:24px;border:1px dashed var(--border);border-radius:14px;text-align:center;color:var(--muted)}

    .history{max-height:360px;overflow:auto}
    details{border:1px solid var(--border);border-radius:12px;background:rgba(255,255,255,.02)}
    details summary{cursor:pointer;padding:12px 14px;list-style:none}
    details[open]{background:rgba(255,255,255,.04)}

    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:rgba(148,163,184,.15);border:1px solid var(--border);padding:2px 6px;border-radius:6px;font-size:12px}
    .footer{margin:24px 0;color:var(--muted);font-size:12px}
    .dangerzone{display:flex;gap:8px;flex-wrap:wrap}

    /* Toast */
    .toast{position:fixed;inset-inline-start:50%;transform:translateX(-50%);bottom:18px;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:var(--shadow);z-index:60;font-weight:700;opacity:0;pointer-events:none;transition:.25s}
    .toast.show{opacity:1; pointer-events:auto}

    /* مصغّرات المرفقات */
    .thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .thumb{width:64px;height:64px;border:1px solid var(--border);border-radius:8px;overflow:hidden;position:relative}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .thumb .x{position:absolute;top:2px;inset-inline-end:2px;background:rgba(0,0,0,.6);color:#fff;border:none;border-radius:6px;padding:2px 4px;cursor:pointer}

    /* الطباعة / PDF */
    #printContainer{display:none}
    @media print{
      @page{ size:A4 portrait; margin:12mm; }
      body{ background:#fff; color:#000 }
      header,.no-print{ display:none !important }
      #printContainer{ display:block !important }
      .report{ font-family:"Tajawal", Arial, sans-serif }
      .report h2, .report h3{ margin:0 0 8px }
      .report .head{ display:flex; justify-content:space-between; align-items:flex-start; gap:10px; margin-bottom:10px }
      .report .head .meta{ color:#333; font-size:12px }
      .report .chips{ display:flex; flex-wrap:wrap; gap:6px; margin:6px 0 12px }
      .report .chip{ border:1px solid #777; color:#000 }
      .print-table{ width:100%; border-collapse:collapse; }
      .print-table th,.print-table td{ border:1px solid #555; padding:6px 8px; font-size:12px; vertical-align:top }
      .print-table th{ background:#f2f2f2 }
      .report .foot{ display:flex; justify-content:space-between; margin-top:18px; font-size:12px }
      .report .sig{ min-width:160px; border-top:1px dashed #777; text-align:center; padding-top:6px }
      .p-cell-att{ display:flex; flex-wrap:wrap; gap:4px; align-items:flex-start }
      .p-thumb{ position:relative; width:60px; height:60px; border:1px solid #555; overflow:hidden }
      .p-thumb img{ width:100%; height:100%; object-fit:cover }
      .p-thumb span{ position:absolute; bottom:0; left:0; right:0; background:rgba(255,255,255,.85); color:#000; font-size:9px; text-align:center; line-height:1.2 }
    }

    /* حوار الكاميرا (ماسح المستند) */
    #cameraDialog{border:none;border-radius:16px;padding:0;max-width:720px;width:calc(100% - 24px);background:var(--panel);color:var(--text)}
    #cameraDialog::backdrop{background:rgba(0,0,0,.62)}
    .cam-h{padding:12px 16px;border-bottom:1px solid var(--border);font-weight:800}
    .cam-b{padding:0}
    .cam-f{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .cam-wrap{position:relative; background:#000}
    #camVideo, #camCanvas{width:100%; height:auto; display:block}
    .cam-overlay{
      position:absolute; inset:0; pointer-events:none;
      background:
        linear-gradient(to right, rgba(255,255,255,.12) 1px, transparent 1px) 0 0/25% 100%,
        linear-gradient(to bottom, rgba(255,255,255,.12) 1px, transparent 1px) 0 0/100% 25%;
      outline:120px solid rgba(0,0,0,.25);
    }
    .cam-tip{position:absolute; bottom:8px; inset-inline:8px; background:rgba(0,0,0,.45); color:#fff; padding:6px 8px; border-radius:8px; font-size:12px}
    .cam-ctrls{display:flex; justify-content:space-between; align-items:center; gap:8px; padding:8px 12px; border-top:1px solid var(--border)}
    .cam-ctrls .left, .cam-ctrls .right{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .seg{display:inline-flex; border:1px solid var(--border); border-radius:10px; overflow:hidden}
    .seg button{background:transparent; border:0; padding:8px 10px; color:var(--text); cursor:pointer}
    .seg button.active{background:var(--primary); color:#fff}
  </style>
</head>
<body>
  <header class="no-print">
    <div class="container brand">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M4 7h16M4 12h16M4 17h10" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
      </svg>
      <h1>دفتر الصادرات والواردات — محل الأثاث</h1>
    </div>
  </header>

  <div class="container no-print" id="app">

    <div class="grid">
      <!-- يسار: سجل اليوم -->
      <section class="card">
        <div class="h">
          <div class="controls">
            <button class="secondary" id="prevDay" title="اليوم السابق">◀</button>
            <input type="date" id="datePicker" />
            <button class="secondary" id="nextDay" title="اليوم التالي">▶</button>
            <button id="todayBtn" title="اليوم">اليوم</button>
            <span class="chip" id="weekday"></span>
          </div>
          <div class="controls">
            <button class="good" id="pdfAll" title="تصدير PDF لليوم (الكل)">PDF اليوم</button>
            <button class="secondary" id="pdfIn" title="تصدير PDF واردات اليوم">PDF الواردات</button>
            <button class="secondary" id="pdfOut" title="تصدير PDF صادرات اليوم">PDF الصادرات</button>
          </div>
        </div>
        <div class="b">
          <div class="summary" id="summary">
            <div class="sum-card sum-in"><h3>الواردات</h3><div class="v" id="sumIn">0.00 د.أ</div></div>
            <div class="sum-card sum-out"><h3>الصادرات</h3><div class="v" id="sumOut">0.00 د.أ</div></div>
            <div class="sum-card sum-net"><h3>الصافي</h3><div class="v" id="sumNet">0.00 د.أ</div></div>
          </div>

          <h3 style="margin:18px 0 8px">إضافة عملية</h3>
          <form id="entryForm" class="row" autocomplete="off">
            <div class="col" style="grid-column: span 12; display:grid; grid-template-columns:repeat(12,1fr); gap:10px">
              <div style="grid-column: span 3">
                <label>النوع</label>
                <select id="type" required>
                  <option value="in">وارد (دخل)</option>
                  <option value="out">صادر (مصروف)</option>
                </select>
              </div>
              <div style="grid-column: span 3">
                <label>المبلغ (د.أ)</label>
                <input type="number" step="0.01" min="0" id="amount" placeholder="0.00" required />
              </div>
              <div style="grid-column: span 3">
                <label>التاريخ</label>
                <input type="date" id="dateInput" required />
              </div>
              <div style="grid-column: span 3">
                <label>الوقت</label>
                <input type="time" id="timeInput" />
              </div>
              <div style="grid-column: span 6">
                <label>العنصر/الشخص</label>
                <input type="text" id="title" placeholder="مثال: طقم كنبايات / دفعة من أحمد" required />
              </div>
              <div style="grid-column: span 6">
                <label>ملاحظة</label>
                <input type="text" id="note" placeholder="تفاصيل إضافية (اختياري)" />
              </div>

              <!-- المرفقات + OCR + كاميرا -->
              <div style="grid-column: span 12">
                <label>مرفقات الفاتورة (صور)</label>
                <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center">
                  <input type="file" id="files" accept="image/*" multiple />
                  <button type="button" id="camBtn" class="secondary" title="التقاط بالموبايل/الكاميرا">التقاط بالكاميرا</button>
                  <button type="button" id="ocrBtn" class="secondary" title="قراءة الفاتورة تلقائيًا">OCR</button>
                </div>
                <div id="filesPreview" class="thumbs"></div>
              </div>
            </div>
            <div class="col" style="grid-column: span 12; display:flex; gap:8px; margin-top:6px">
              <button type="submit">إضافة للسجل</button>
              <button type="reset" class="secondary">تفريغ</button>
            </div>
          </form>

          <h3 style="margin:22px 0 8px">سجل اليوم</h3>
          <div id="dayList" class="list"></div>
        </div>
      </section>

      <!-- يمين: الأرشيف -->
      <aside class="card">
        <div class="h">
          <div>الأرشيف — حسب اليوم</div>
          <div class="controls">
            <button class="secondary" id="expandAll">فتح الكل</button>
            <button class="secondary" id="collapseAll">إغلاق الكل</button>
          </div>
        </div>
        <div class="b history" id="history"></div>
        <div class="b">
          <div class="footer" style="margin-top:4px">
            كل البيانات محفوظة محليًا على جهازك (LocalStorage + IndexedDB للمرفقات).
          </div>
          <div style="margin-top:10px">
            <details>
              <summary>منطقة خطرة</summary>
              <div class="dangerzone" style="margin-top:10px">
                <button class="danger" id="wipeAll">حذف كل البيانات</button>
              </div>
            </details>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- نافذة تحرير -->
  <dialog id="editDialog" class="no-print">
    <div class="dlg-h" style="padding:14px 16px;border-bottom:1px solid var(--border);font-weight:800">تعديل العملية</div>
    <div class="dlg-b" style="padding:16px">
      <form id="editForm" class="row">
        <input type="hidden" id="editId" />
        <input type="hidden" id="editDateKey" />
        <div style="grid-column: span 6">
          <label>النوع</label>
          <select id="editType" required>
            <option value="in">وارد (دخل)</option>
            <option value="out">صادر (مصروف)</option>
          </select>
        </div>
        <div style="grid-column: span 6">
          <label>المبلغ (د.أ)</label>
          <input type="number" step="0.01" min="0" id="editAmount" required />
        </div>
        <div style="grid-column: span 6">
          <label>العنصر/الشخص</label>
          <input type="text" id="editTitle" required />
        </div>
        <div style="grid-column: span 6">
          <label>ملاحظة</label>
          <input type="text" id="editNote" />
        </div>
        <div style="grid-column: span 6">
          <label>التاريخ</label>
          <input type="date" id="editDate" required />
        </div>
        <div style="grid-column: span 6">
          <label>الوقت</label>
          <input type="time" id="editTime" />
        </div>

        <!-- مرفقات في نافذة التعديل -->
        <div style="grid-column: span 12">
          <label>المرفقات الحالية</label>
          <div id="editOldAtt" class="thumbs"></div>
        </div>
        <div style="grid-column: span 12">
          <label>إضافة مرفقات جديدة</label>
          <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center">
            <input type="file" id="editFiles" accept="image/*" multiple />
            <button type="button" id="editCamBtn" class="secondary">التقاط بالكاميرا</button>
          </div>
          <div id="editFilesPreview" class="thumbs"></div>
        </div>
      </form>
    </div>
    <div class="dlg-f" style="padding:12px 16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px">
      <button class="secondary" id="cancelEdit">إلغاء</button>
      <button id="saveEdit">حفظ</button>
    </div>
  </dialog>

  <!-- حوار استعراض المرفقات -->
  <dialog id="attDialog" class="no-print">
    <div style="padding:12px 16px;border-bottom:1px solid var(--border);font-weight:800">مرفقات الفاتورة</div>
    <div id="attBody" style="padding:12px 16px;display:flex;flex-wrap:wrap;gap:10px"></div>
    <div style="padding:12px 16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px">
      <button class="secondary" id="attClose">إغلاق</button>
    </div>
  </dialog>

  <!-- حوار الكاميرا -->
  <dialog id="cameraDialog" class="no-print">
    <div class="cam-h">التقاط مستند بالكاميرا</div>
    <div class="cam-b">
      <div class="cam-wrap">
        <video id="camVideo" playsinline autoplay></video>
        <canvas id="camCanvas" style="display:none"></canvas>
        <div class="cam-overlay"></div>
        <div class="cam-tip">ضع الفاتورة داخل الإطار، ثبّت الجهاز وحاول تجنّب الظلال. استخدم الإضاءة عند الحاجة.</div>
      </div>
      <div class="cam-ctrls">
        <div class="left">
          <div class="seg" aria-label="وضع المسح">
            <button type="button" data-mode="auto" class="active" id="modeAuto">تحسين</button>
            <button type="button" data-mode="color" id="modeColor">ملون</button>
            <button type="button" data-mode="bw" id="modeBW">أبيض وأسود</button>
          </div>
          <button type="button" class="secondary" id="rotateBtn" title="تدوير 90°">↻ تدوير</button>
        </div>
        <div class="right">
          <button type="button" class="secondary" id="torchBtn" title="إضاءة">💡</button>
          <button type="button" class="secondary" id="flipBtn" title="تبديل الكاميرا">🔄</button>
          <button type="button" class="good" id="shootBtn" title="التقاط">● التقاط</button>
          <button type="button" class="secondary" id="retakeBtn" style="display:none">إعادة</button>
          <button type="button" id="usePhotoBtn" style="display:none">استخدام الصورة</button>
          <button type="button" class="secondary" id="closeCam">إغلاق</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- منطقة إنشاء تقرير الطباعة / PDF -->
  <div id="printContainer" aria-hidden="true"></div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Tesseract (OCR اختياري) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>

<script>
(function(){
  const LS_KEY = 'furnitureLedgerV1';
  const currency = 'د.أ';

  // عناصر DOM أساسية
  const datePicker = document.getElementById('datePicker');
  const weekdayEl = document.getElementById('weekday');
  const prevDayBtn = document.getElementById('prevDay');
  const nextDayBtn = document.getElementById('nextDay');
  const todayBtn = document.getElementById('todayBtn');
  const dayList = document.getElementById('dayList');
  const sumIn = document.getElementById('sumIn');
  const sumOut = document.getElementById('sumOut');
  const sumNet = document.getElementById('sumNet');
  const historyEl = document.getElementById('history');

  const pdfAllBtn = document.getElementById('pdfAll');
  const pdfInBtn  = document.getElementById('pdfIn');
  const pdfOutBtn = document.getElementById('pdfOut');

  const expandAll = document.getElementById('expandAll');
  const collapseAll = document.getElementById('collapseAll');
  const wipeAll = document.getElementById('wipeAll');

  // المرفقات + OCR + كاميرا
  const filesInput = document.getElementById('files');
  const filesPreview = document.getElementById('filesPreview');
  const ocrBtn = document.getElementById('ocrBtn');
  const camBtn = document.getElementById('camBtn');

  // نافذة المرفقات
  const attDialog = document.getElementById('attDialog');
  const attBody = document.getElementById('attBody');
  const attClose = document.getElementById('attClose');

  // فورم الإضافة
  const form = document.getElementById('entryForm');
  const type = document.getElementById('type');
  const amount = document.getElementById('amount');
  const title = document.getElementById('title');
  const note = document.getElementById('note');
  const dateInput = document.getElementById('dateInput');
  const timeInput = document.getElementById('timeInput');

  // حوار التحرير
  const editDialog = document.getElementById('editDialog');
  const editId = document.getElementById('editId');
  const editType = document.getElementById('editType');
  const editAmount = document.getElementById('editAmount');
  const editTitle = document.getElementById('editTitle');
  const editNote = document.getElementById('editNote');
  const editDate = document.getElementById('editDate');
  const editTime = document.getElementById('editTime');
  const editDateKey = document.getElementById('editDateKey');
  const editOldAtt = document.getElementById('editOldAtt');
  const editFiles = document.getElementById('editFiles');
  const editFilesPreview = document.getElementById('editFilesPreview');
  const editCamBtn = document.getElementById('editCamBtn');

  // حوار الكاميرا
  const cameraDialog = document.getElementById('cameraDialog');
  const camVideo = document.getElementById('camVideo');
  const camCanvas = document.getElementById('camCanvas');
  const shootBtn = document.getElementById('shootBtn');
  const retakeBtn = document.getElementById('retakeBtn');
  const usePhotoBtn = document.getElementById('usePhotoBtn');
  const closeCamBtn = document.getElementById('closeCam');
  const torchBtn = document.getElementById('torchBtn');
  const flipBtn = document.getElementById('flipBtn');
  const rotateBtn = document.getElementById('rotateBtn');
  const modeAuto = document.getElementById('modeAuto');
  const modeColor = document.getElementById('modeColor');
  const modeBW = document.getElementById('modeBW');

  const printContainer = document.getElementById('printContainer');
  const toastEl = document.getElementById('toast');

  // وقت/تاريخ
  const toKey = (d) => {
    const dt = new Date(d.getTime());
    dt.setHours(0,0,0,0);
    const y = dt.getFullYear();
    const m = String(dt.getMonth()+1).padStart(2,'0');
    const da = String(dt.getDate()).padStart(2,'0');
    return `${y}-${m}-${da}`;
  };
  const fromKey = (k) => { const [y,m,d] = k.split('-').map(Number); const dt = new Date(y, m-1, d); dt.setHours(0,0,0,0); return dt; };
  const weekdayName = (date) => new Intl.DateTimeFormat('ar-JO',{weekday:'long'}).format(date);
  const numFmt = new Intl.NumberFormat('ar-JO',{minimumFractionDigits:2, maximumFractionDigits:2});

  // تخزين
  const load = () => { try{ return JSON.parse(localStorage.getItem(LS_KEY)) || { days:{} }; } catch{ return { days:{} }; } };
  const save = (data) => localStorage.setItem(LS_KEY, JSON.stringify(data));

  // حالة التطبيق
  let state = load();
  let selected = toKey(new Date());

  // IndexedDB للمرفقات
  const DB_NAME='furnitureLedgerDB', DB_VER=1;
  let dbPromise = initDB();
  async function initDB(){
    return new Promise((res,rej)=>{
      if(!('indexedDB' in window)){ res(null); return; }
      const req = indexedDB.open(DB_NAME, DB_VER);
      req.onupgradeneeded = ()=> {
        const db = req.result;
        if(!db.objectStoreNames.contains('attachments')){
          db.createObjectStore('attachments'); // key=id
        }
      };
      req.onsuccess = ()=> res(req.result);
      req.onerror   = ()=> rej(req.error);
    });
  }
  function txPut(db, store, key, val){ return new Promise((res,rej)=>{ const tx=db.transaction(store,'readwrite'); tx.objectStore(store).put(val,key); tx.oncomplete=res; tx.onerror=()=>rej(tx.error); }); }
  function txGet(db, store, key){ return new Promise((res,rej)=>{ const tx=db.transaction(store,'readonly'); const req=tx.objectStore(store).get(key); req.onsuccess=()=>res(req.result); req.onerror=()=>rej(req.error); }); }
  function txDel(db, store, key){ return new Promise((res,rej)=>{ const tx=db.transaction(store,'readwrite'); tx.objectStore(store).delete(key); tx.oncomplete=res; tx.onerror=()=>rej(tx.error); }); }
  async function putAttachment(blob){
    const id = 'att_' + cryptoRandomId();
    const db = await dbPromise;
    if(!db){ throw new Error('لا يوجد دعم للمرفقات'); }
    await txPut(db,'attachments', id, blob);
    return id;
  }
  async function getAttachment(id){
    const db = await dbPromise; if(!db) return null;
    return txGet(db,'attachments', id);
  }
  async function deleteAttachment(id){
    const db = await dbPromise; if(!db) return;
    return txDel(db,'attachments', id);
  }

  // ضغط/تجهيز الصور
  async function fileToImage(file){
    return new Promise((res,rej)=>{
      const fr = new FileReader();
      fr.onload = e=>{
        const img = new Image();
        img.onload = ()=> res(img);
        img.onerror = rej;
        img.src = e.target.result;
      };
      fr.onerror = rej;
      fr.readAsDataURL(file);
    });
  }
  function dataURLToBlob(dataURL){
    const parts = dataURL.split(','), mime = parts[0].match(/:(.*?);/)[1];
    const bin = atob(parts[1]); const len = bin.length; const u8 = new Uint8Array(len);
    for(let i=0;i<len;i++) u8[i]=bin.charCodeAt(i);
    return new Blob([u8], {type:mime});
  }
  async function compressImage(fileOrBlob, maxSide=1600, quality=0.9){
    const src = (fileOrBlob instanceof Blob && !(fileOrBlob instanceof File)) ? URL.createObjectURL(fileOrBlob) : null;
    const img = await (src ? new Promise((res,rej)=>{ const im=new Image(); im.onload=()=>res(im); im.onerror=rej; im.src=src; }) : fileToImage(fileOrBlob));
    const w = img.width, h = img.height, scale = Math.min(1, maxSide / Math.max(w, h));
    const canvas = document.createElement('canvas');
    canvas.width = Math.round(w * scale);
    canvas.height = Math.round(h * scale);
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    const blob = await new Promise(r=> canvas.toBlob(b=> r(b || dataURLToBlob(canvas.toDataURL('image/jpeg', quality))), 'image/jpeg', quality));
    if(src) URL.revokeObjectURL(src);
    return blob;
  }

  // فلاتر تحسين للمسح
  function enhanceCanvas(canvas, mode='auto', rotateSteps=0){
    const ctx = canvas.getContext('2d');
    if(rotateSteps){
      const tmp = document.createElement('canvas');
      tmp.width = canvas.width; tmp.height = canvas.height;
      tmp.getContext('2d').drawImage(canvas,0,0);
      if(rotateSteps % 4 !==0){
        const turns = ((rotateSteps%4)+4)%4;
        if(turns === 1 || turns === 3){
          canvas.width = tmp.height; canvas.height = tmp.width;
        }
        const c = canvas.getContext('2d');
        c.save();
        c.translate(canvas.width/2, canvas.height/2);
        c.rotate(turns*Math.PI/2);
        c.drawImage(tmp, -tmp.width/2, -tmp.height/2);
        c.restore();
      }
    }
    const {width:w, height:h} = canvas;
    const imageData = ctx.getImageData(0,0,w,h);
    const d = imageData.data;

    // حساب إضاءة أساسية
    let sum=0, sum2=0;
    for(let i=0;i<d.length;i+=4){
      const lum = 0.2126*d[i] + 0.7152*d[i+1] + 0.0722*d[i+2];
      sum += lum; sum2 += lum*lum;
    }
    const n = d.length/4;
    const mean = sum/n, std = Math.sqrt(Math.max(1, sum2/n - mean*mean));
    const targetStd = 70; // تباين مستهدف
    const k = std ? targetStd/std : 1;

    for(let i=0;i<d.length;i+=4){
      let r=d[i], g=d[i+1], b=d[i+2];
      const lum = 0.2126*r + 0.7152*g + 0.0722*b;
      let nl = (lum - mean)*k + mean; // توسيع المجال
      nl = Math.max(0, Math.min(255, nl));

      if(mode==='bw'){
        const v = nl>140 ? 255 : (nl<110 ? 0 : nl); // عتبة بسيطة
        d[i]=d[i+1]=d[i+2]=v;
      } else if(mode==='color'){
        // تصحيح بسيط: رفع التشبع الخفيف
        const scale = lum ? nl/lum : 1;
        d[i]   = Math.max(0, Math.min(255, r*scale));
        d[i+1] = Math.max(0, Math.min(255, g*scale));
        d[i+2] = Math.max(0, Math.min(255, b*scale));
      } else {
        // auto: خليط أبيض وأسود خفيف مع لون
        const scale = lum ? nl/lum : 1;
        r = r*scale; g=g*scale; b=b*scale;
        const gray = nl;
        // مزج 30% تدرج رمادي لإزالة صبغات
        d[i]   = 0.7*r + 0.3*gray;
        d[i+1] = 0.7*g + 0.3*gray;
        d[i+2] = 0.7*b + 0.3*gray;
      }
      // تقليل الضوضاء الطفيفة: قص القيم
      d[i] = d[i]<2?0:d[i]>253?255:d[i];
      d[i+1] = d[i+1]<2?0:d[i+1]>253?255:d[i+1];
      d[i+2] = d[i+2]<2?0:d[i+2]>253?255:d[i+2];
    }
    ctx.putImageData(imageData,0,0);
    // Unsharp mask بسيط
    boxBlur(canvas, 2);
    const sharp = ctx.getImageData(0,0,w,h);
    const s = sharp.data;
    const amt = 0.4;
    for(let i=0;i<d.length;i+=4){
      d[i]   = clamp255(d[i]   + amt*(d[i]   - s[i]));
      d[i+1] = clamp255(d[i+1] + amt*(d[i+1] - s[i+1]));
      d[i+2] = clamp255(d[i+2] + amt*(d[i+2] - s[i+2]));
    }
    ctx.putImageData(imageData,0,0);
  }
  function clamp255(x){ return x<0?0:(x>255?255:x); }
  function boxBlur(canvas, r){
    const ctx = canvas.getContext('2d');
    const {width:w,height:h} = canvas;
    const img = ctx.getImageData(0,0,w,h);
    const d = img.data;
    const out = new Uint8ClampedArray(d.length);
    const tmp = new Uint8ClampedArray(d.length);

    // أفقي
    for(let y=0;y<h;y++){
      let rsum=0, gsum=0, bsum=0, asum=0;
      let i = y*w*4;
      for(let x=-r;x<=r;x++){
        const xi = Math.max(0, Math.min(w-1, x));
        const idx = (y*w + xi)*4;
        rsum+=d[idx]; gsum+=d[idx+1]; bsum+=d[idx+2]; asum+=d[idx+3];
      }
      for(let x=0;x<w;x++){
        const idx = (y*w + x)*4;
        tmp[idx]   = rsum/(2*r+1);
        tmp[idx+1] = gsum/(2*r+1);
        tmp[idx+2] = bsum/(2*r+1);
        tmp[idx+3] = asum/(2*r+1);
        const x1 = Math.max(0, x-r);
        const x2 = Math.min(w-1, x+r+1);
        const i1=(y*w + x1)*4, i2=(y*w + x2)*4;
        rsum += d[i2]-d[i1]; gsum += d[i2+1]-d[i1+1]; bsum += d[i2+2]-d[i1+2]; asum += d[i2+3]-d[i1+3];
      }
    }
    // عمودي
    for(let x=0;x<w;x++){
      let rsum=0, gsum=0, bsum=0, asum=0;
      for(let y=-r;y<=r;y++){
        const yi = Math.max(0, Math.min(h-1, y));
        const idx = (yi*w + x)*4;
        rsum+=tmp[idx]; gsum+=tmp[idx+1]; bsum+=tmp[idx+2]; asum+=tmp[idx+3];
      }
      for(let y=0;y<h;y++){
        const idx = (y*w + x)*4;
        out[idx]   = rsum/(2*r+1);
        out[idx+1] = gsum/(2*r+1);
        out[idx+2] = bsum/(2*r+1);
        out[idx+3] = asum/(2*r+1);
        const y1 = Math.max(0, y-r);
        const y2 = Math.min(h-1, y+r+1);
        const i1=(y1*w + x)*4, i2=(y2*w + x)*4;
        rsum += tmp[i2]-tmp[i1]; gsum += tmp[i2+1]-tmp[i1+1]; bsum += tmp[i2+2]-tmp[i1+2]; asum += tmp[i2+3]-tmp[i1+3];
      }
    }
    for(let i=0;i<d.length;i++) d[i]=out[i];
    ctx.putImageData(img,0,0);
  }

  // Toast
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    setTimeout(()=> toastEl.classList.remove('show'), 1600);
  }

  // تاريخ افتراضي
  const initDateControls = () => {
    datePicker.value = selected;
    dateInput.value = selected;
    timeInput.value = new Date().toTimeString().slice(0,5);
    weekdayEl.textContent = weekdayName(fromKey(selected));
  };

  // CRUD (يدعم attachments)
  const addEntry = ({dateKey, kind, amount, title, note, time, attachments}) => {
    const id = cryptoRandomId();
    const createdAt = Date.now();
    if(!state.days[dateKey]) state.days[dateKey] = [];
    state.days[dateKey].push({ id, kind, amount, title, note, time, createdAt, attachments: attachments||[] });
    save(state);
  };
  const updateEntry = ({oldDateKey, id, dateKey, kind, amount, title, note, time, attachments}) => {
    const list = state.days[oldDateKey] || [];
    const idx = list.findIndex(x => x.id === id);
    if(idx === -1) return;
    const item = list[idx];
    const updated = { ...item, kind, amount, title, note, time, attachments: Array.isArray(attachments) ? attachments : (item.attachments||[]) };
    if(oldDateKey !== dateKey){
      list.splice(idx,1);
      if(!state.days[dateKey]) state.days[dateKey] = [];
      state.days[dateKey].push(updated);
      if(list.length === 0) delete state.days[oldDateKey];
    } else {
      list[idx] = updated;
    }
    save(state);
  };
  async function deleteEntry(dateKey, id){
    const list = state.days[dateKey] || [];
    const idx = list.findIndex(x => x.id === id);
    if(idx === -1) return;
    const [removed] = list.splice(idx,1);
    if(list.length === 0) delete state.days[dateKey];
    save(state);
    if(removed && removed.attachments){
      for(const aid of removed.attachments){ try{ await deleteAttachment(aid); }catch{} }
    }
  }

  function cryptoRandomId(){
    if(window.crypto && crypto.getRandomValues){
      const a = crypto.getRandomValues(new Uint32Array(4));
      return [...a].map(x=>x.toString(16).padStart(8,'0')).join('');
    }
    return Math.random().toString(16).slice(2)+Date.now().toString(16);
  }

  // عرض اليوم
  const renderDay = (dateKey) => {
    const list = (state.days[dateKey] || []).slice().sort((a,b)=> a.createdAt - b.createdAt);
    dayList.innerHTML = '';
    if(list.length === 0){
      dayList.innerHTML = `<div class="empty">لا توجد عمليات لهذا اليوم.</div>`;
    } else {
      list.forEach(item => {
        const row = document.createElement('div');
        row.className = 'item';
        row.dataset.id = item.id;
        row.dataset.dateKey = dateKey;
        const chipClass = item.kind === 'in' ? 'chip in' : 'chip out';
        const attCount = (item.attachments||[]).length;
        row.innerHTML = `
          <div>
            <div class="meta">
              <span class="${chipClass}">${item.kind === 'in' ? 'وارد' : 'صادر'}</span>
              <span class="chip">${item.time || '--:--'}</span>
              ${attCount ? `<span class="chip">📎 ${attCount} مرفق</span>` : ``}
            </div>
            <div class="title" style="margin-top:6px">${escapeHtml(item.title || '')}</div>
            <div class="note">${escapeHtml(item.note || '')}</div>
          </div>
          <div style="text-align:end">
            <div class="amt">${numFmt.format(Number(item.amount||0))} ${currency}</div>
            <div class="act" style="margin-top:8px">
              ${attCount ? `<button class="secondary" data-act="att">مرفقات</button>` : ``}
              <button class="secondary" data-act="edit">تعديل</button>
              <button class="danger" data-act="del">حذف</button>
            </div>
          </div>
        `;
        dayList.appendChild(row);
      });
    }
    const totalIn = list.filter(x=>x.kind==='in').reduce((s,x)=>s + Number(x.amount||0),0);
    const totalOut = list.filter(x=>x.kind==='out').reduce((s,x)=>s + Number(x.amount||0),0);
    sumIn.textContent = `${numFmt.format(totalIn)} ${currency}`;
    sumOut.textContent = `${numFmt.format(totalOut)} ${currency}`;
    sumNet.textContent = `${numFmt.format(totalIn - totalOut)} ${currency}`;
  };

  // الأرشيف
  const renderHistory = () => {
    const keys = Object.keys(state.days).sort((a,b)=> b.localeCompare(a));
    historyEl.innerHTML = '';
    if(keys.length === 0){
      historyEl.innerHTML = '<div class="empty">لا توجد بيانات محفوظة بعد.</div>';
      return;
    }
    keys.forEach(k => {
      const list = state.days[k] || [];
      const totalIn = list.filter(x=>x.kind==='in').reduce((s,x)=>s + Number(x.amount||0),0);
      const totalOut = list.filter(x=>x.kind==='out').reduce((s,x)=>s + Number(x.amount||0),0);
      const net = totalIn - totalOut;

      const details = document.createElement('details');
      const dt = fromKey(k);
      details.innerHTML = `
        <summary>
          <strong>${k}</strong> — ${weekdayName(dt)}
          <span class="chip in" style="margin-inline:6px">واردات: ${numFmt.format(totalIn)} ${currency}</span>
          <span class="chip out">صادرات: ${numFmt.format(totalOut)} ${currency}</span>
          <span class="chip" style="margin-inline:6px">الصافي: ${numFmt.format(net)} ${currency}</span>
          <span class="chip" data-go-day="${k}" title="فتح هذا اليوم">عرض</span>
        </summary>
        <div class="b" style="padding:12px 14px">
          ${(list||[]).map(it => `
            <div class="item" style="margin-bottom:8px">
              <div>
                <div class="meta">
                  <span class="${it.kind==='in'?'chip in':'chip out'}">${it.kind==='in'?'وارد':'صادر'}</span>
                  <span class="chip">${it.time || '--:--'}</span>
                  ${(it.attachments && it.attachments.length) ? `<span class="chip">📎 ${it.attachments.length} مرفق</span>` : ``}
                </div>
                <div class="title" style="margin-top:6px">${escapeHtml(it.title||'')}</div>
                <div class="note">${escapeHtml(it.note||'')}</div>
              </div>
              <div style="text-align:end">
                <div class="amt">${numFmt.format(Number(it.amount||0))} ${currency}</div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
      historyEl.appendChild(details);
    });
  };

  // أدوات مساعدة
  function escapeHtml(str){ return String(str).replace(/[&<>"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s])); }

  // ****** مرفقات: إدخال ومعاينة ******
  let pendingAtt = []; // {blob, url}
  function addThumb(url, container, onRemove){
    const div=document.createElement('div'); div.className='thumb';
    div.innerHTML = `<img src="${url}" alt="صورة"><button class="x" title="إزالة">×</button>`;
    div.querySelector('.x').onclick=()=>{
      onRemove?.();
      div.remove();
    };
    container.appendChild(div);
  }

  filesInput?.addEventListener('change', async ()=>{
    // فرّغ السابقة
    pendingAtt.forEach(p=>{ try{ URL.revokeObjectURL(p.url); }catch{} });
    pendingAtt=[]; filesPreview.innerHTML='';
    if(!filesInput.files || !filesInput.files.length) return;
    if(!('indexedDB' in window)){ toast('متصفحك لا يدعم المرفقات؛ تم تعطيلها'); filesInput.value=''; return; }
    const MAX_FILES = 6;
    let count = 0;
    for (const file of filesInput.files) {
      if(!file.type.startsWith('image/')) continue;
      if(count >= MAX_FILES){ toast('تم الوصول للحد الأقصى للمرفقات'); break; }
      try{
        const blob = await compressImage(file, 1600, 0.9);
        const url = URL.createObjectURL(blob);
        const idx = pendingAtt.length;
        pendingAtt.push({blob, url});
        addThumb(url, filesPreview, ()=>{
          URL.revokeObjectURL(pendingAtt[idx]?.url);
          pendingAtt[idx]=null;
        });
        count++;
      }catch{}
    }
    pendingAtt = pendingAtt.filter(Boolean);
  });

  // OCR
  ocrBtn?.addEventListener('click', async ()=>{
    try{
      if(!window.Tesseract){ alert('OCR غير متاح حالياً'); return; }
      if(pendingAtt.length===0){ toast('أضف/التقط صورة فاتورة أولاً'); return; }
      const blob = pendingAtt[0].blob;
      const { data } = await Tesseract.recognize(blob, 'ara+eng', { logger:m=>console.log(m) });
      const text = (data.text || '').replace(/\s+/g,' ').trim();

      const amtMatch  = text.match(/(\d{1,3}(?:[.,]\d{3})*(?:[.,]\d{2})?|\d+(?:[.,]\d{2})?)/);
      const dateMatch = text.match(/(\d{4}[\/\-\.]\d{1,2}[\/\-\.]\d{1,2}|\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4})/);

      if(amtMatch && !amount.value){
        let norm = amtMatch[1].replace(/\s/g,'');
        if(/,\d{3}/.test(norm)) norm = norm.replace(/,/g,'');
        const parts = norm.split(',');
        if(parts.length===2 && !parts[1].includes('.')) norm = parts[0]+'.'+parts[1];
        amount.value = norm;
      }
      if(dateMatch && !dateInput.value){
        const norm = normalizeDate(dateMatch[1]);
        if(norm) dateInput.value = norm;
      }
      if(!note.value) note.value = 'OCR';
      toast('تمت قراءة الفاتورة مبدئيًا — راجع قبل الحفظ');
    }catch(err){
      console.error(err);
      toast('تعذر قراءة الفاتورة');
    }
  });

  function normalizeDate(raw){
    const s = raw.replace(/\./g,'/').replace(/-/g,'/');
    const parts = s.split('/');
    if(parts.length!==3) return null;
    let y,m,d;
    if(parts[0].length===4){ y=+parts[0]; m=+parts[1]; d=+parts[2]; }
    else { d=+parts[0]; m=+parts[1]; y=+parts[2]; if(y<100) y+=2000; }
    const dt = new Date(y, m-1, d);
    if(isNaN(dt)) return null;
    return toKey(dt);
  }

  // ****** أحداث عامة ******
  datePicker.addEventListener('change', () => {
    selected = datePicker.value || selected;
    dateInput.value = selected;
    weekdayEl.textContent = weekdayName(fromKey(selected));
    renderDay(selected);
  });
  prevDayBtn.addEventListener('click', ()=>{ moveSelected(-1); });
  nextDayBtn.addEventListener('click', ()=>{ moveSelected(+1); });
  todayBtn.addEventListener('click', ()=>{
    selected = toKey(new Date());
    datePicker.value = selected;
    dateInput.value = selected;
    weekdayEl.textContent = weekdayName(new Date());
    renderDay(selected);
  });

  function moveSelected(deltaDays){
    const d = fromKey(selected);
    d.setDate(d.getDate()+deltaDays);
    selected = toKey(d);
    datePicker.value = selected; dateInput.value = selected; weekdayEl.textContent = weekdayName(d); renderDay(selected);
  }

  // حفظ عملية جديدة (مع المرفقات)
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const kind = type.value;
    const amt = Number(amount.value);
    const ttl = title.value.trim();
    const nt = (note.value||'').trim();
    const dtKey = dateInput.value || selected;
    let tm = timeInput.value;

    if(!Number.isFinite(amt) || amt <= 0){ toast('أدخل مبلغًا صحيحًا أكبر من صفر'); return; }
    if(!ttl){ toast('الرجاء كتابة اسم القطعة أو الشخص'); return; }
    if(!tm){ tm = new Date().toTimeString().slice(0,5); }

    const attIds = [];
    if(pendingAtt.length){
      if(!('indexedDB' in window)){ toast('متصفحك لا يدعم المرفقات؛ تم تجاهلها'); }
      else {
        for(const p of pendingAtt){
          try{ const id = await putAttachment(p.blob); attIds.push(id); }
          catch{}
          finally{ URL.revokeObjectURL(p.url); }
        }
      }
      pendingAtt = []; filesInput.value=''; filesPreview.innerHTML='';
    }

    addEntry({dateKey: dtKey, kind, amount: amt, title: ttl, note: nt, time: tm, attachments: attIds});

    if(dtKey === selected){ renderDay(selected); }
    renderHistory();
    form.reset();
    dateInput.value = selected;
    timeInput.value = new Date().toTimeString().slice(0,5);
    amount.focus();
    toast('تمت الإضافة');
  });

  // نقرات على عناصر السجل
  dayList.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button');
    if(!btn) return;
    const act = btn.dataset.act;
    const row = btn.closest('.item');
    const id = row?.dataset.id;
    const dateKey = row?.dataset.dateKey;
    if(!id || !dateKey) return;

    if(act === 'del'){
      if(confirm('هل تريد حذف هذه العملية؟')){
        await deleteEntry(dateKey, id);
        renderDay(selected);
        renderHistory();
        toast('تم الحذف');
      }
    }
    if(act === 'edit'){
      openEditDialog(dateKey, id);
    }
    if(act === 'att'){
      const item = (state.days[dateKey]||[]).find(x=>x.id===id);
      openAttachments(item?.attachments || []);
    }
  });

  // فتح نافذة التعديل مع مرفقات
  let editPendingAtt = [];     // مرفقات جديدة {blob, url}
  let editDeleteIds  = new Set(); // معرفات مرفقات قديمة للحذف
  let editOldUrlMap  = new Map(); // id -> blobURL

  async function openEditDialog(dateKey, id){
    const item = (state.days[dateKey]||[]).find(x=>x.id===id);
    if(!item) return;
    // حقول أساسية
    editId.value = id;
    editDateKey.value = dateKey;
    editType.value = item.kind;
    editAmount.value = item.amount;
    editTitle.value = item.title || '';
    editNote.value = item.note || '';
    editDate.value = dateKey;
    editTime.value = item.time || '';

    // نظّف حالة المرفقات
    cleanupEditDialog();

    // اعرض المرفقات الحالية
    const ids = item.attachments || [];
    for(const aid of ids){
      try{
        const blob = await getAttachment(aid);
        if(!blob) continue;
        const url = URL.createObjectURL(blob);
        editOldUrlMap.set(aid, url);
        const div=document.createElement('div'); div.className='thumb';
        div.innerHTML = `<img src="${url}" alt="مرفق"><button class="x" title="حذف">×</button>`;
        div.querySelector('.x').onclick=()=>{
          editDeleteIds.add(aid);
          div.remove();
        };
        editOldAtt.appendChild(div);
      }catch{}
    }

    editDialog.showModal();
  }

  function cleanupEditDialog(){
    editOldUrlMap.forEach(url=> URL.revokeObjectURL(url));
    editOldUrlMap.clear();
    editPendingAtt.forEach(p=>{ try{ URL.revokeObjectURL(p.url); }catch{} });
    editPendingAtt = [];
    editDeleteIds.clear();
    editOldAtt.innerHTML = '';
    editFilesPreview.innerHTML = '';
    editFiles.value = '';
  }

  // اختيار مرفقات جديدة في التعديل
  editFiles?.addEventListener('change', async ()=>{
    editFilesPreview.innerHTML='';
    editPendingAtt.forEach(p=>{ try{ URL.revokeObjectURL(p.url); }catch{} });
    editPendingAtt = [];
    if(!editFiles.files || !editFiles.files.length) return;
    if(!('indexedDB' in window)){ toast('متصفحك لا يدعم المرفقات'); editFiles.value=''; return; }
    const MAX_FILES = 6;
    let count = 0;
    for (const file of editFiles.files) {
      if(!file.type.startsWith('image/')) continue;
      if(count >= MAX_FILES){ toast('تم الوصول للحد الأقصى للمرفقات'); break; }
      try{
        const blob = await compressImage(file, 1600, 0.9);
        const url = URL.createObjectURL(blob);
        const idx = editPendingAtt.length;
        editPendingAtt.push({blob, url});
        addThumb(url, editFilesPreview, ()=>{
          URL.revokeObjectURL(editPendingAtt[idx]?.url);
          editPendingAtt[idx]=null;
        });
        count++;
      }catch{}
    }
    editPendingAtt = editPendingAtt.filter(Boolean);
  });

  document.getElementById('cancelEdit').addEventListener('click', ()=>{
    cleanupEditDialog();
    editDialog.close();
  });

  document.getElementById('saveEdit').addEventListener('click', async ()=>{
    const id = editId.value;
    const oldDateKey = editDateKey.value;
    const newDateKey = editDate.value || oldDateKey;
    const kind = editType.value;
    const amt = Number(editAmount.value);
    const ttl = editTitle.value.trim();
    const nt = (editNote.value||'').trim();
    const tm = editTime.value || '--:--';

    if(!Number.isFinite(amt) || amt <= 0){ toast('المبلغ غير صالح'); return; }
    if(!ttl){ toast('يجب إدخال العنصر/الشخص'); return; }

    const curItem = (state.days[oldDateKey]||[]).find(x=>x.id===id) || {};
    const currentIds = Array.isArray(curItem.attachments) ? curItem.attachments.slice() : [];
    const keepIds = currentIds.filter(aid=> !editDeleteIds.has(aid));

    const newIds = [];
    for(const p of editPendingAtt){
      try{ const nid = await putAttachment(p.blob); newIds.push(nid); }catch{}
    }
    const finalAttachments = keepIds.concat(newIds);

    updateEntry({oldDateKey, id, dateKey:newDateKey, kind, amount:amt, title:ttl, note:nt, time:tm, attachments: finalAttachments});

    for(const aid of editDeleteIds){ try{ await deleteAttachment(aid); }catch{} }

    cleanupEditDialog();
    editDialog.close();

    if(newDateKey === selected || oldDateKey === selected){ renderDay(selected); }
    renderHistory();
    toast('تم الحفظ');
  });

  // الأرشيف: فتح يوم معيّن
  historyEl.addEventListener('click', (e)=>{
    const go = e.target.closest('[data-go-day]');
    if(go){
      selected = go.dataset.goDay;
      datePicker.value = selected;
      dateInput.value = selected;
      weekdayEl.textContent = weekdayName(fromKey(selected));
      renderDay(selected);
      window.scrollTo({top:0, behavior:'smooth'});
    }
  });

  // فتح/إغلاق كل الأيام
  expandAll.addEventListener('click', ()=>{ historyEl.querySelectorAll('details').forEach(d=> d.open = true); });
  collapseAll.addEventListener('click', ()=>{ historyEl.querySelectorAll('details').forEach(d=> d.open = false); });

  // حذف جميع البيانات
  wipeAll.addEventListener('click', async ()=>{
    if(confirm('تحذير: سيتم حذف كل البيانات نهائيًا. هل أنت متأكد؟')){
      try{
        const db = await dbPromise;
        if(db){
          const tx = db.transaction('attachments','readwrite');
          tx.objectStore('attachments').clear();
          await new Promise((r,_)=>{ tx.oncomplete=r; });
        }
      }catch{}
      state = { days:{} };
      save(state);
      renderDay(selected);
      renderHistory();
      toast('تم حذف كل البيانات');
    }
  });

  // PDF: إنشاء تقرير اليوم — المرفقات داخل الصفوف
  pdfAllBtn.addEventListener('click', ()=> exportPDF('all'));
  pdfInBtn.addEventListener('click',  ()=> exportPDF('in'));
  pdfOutBtn.addEventListener('click', ()=> exportPDF('out'));

  async function exportPDF(mode){
    const dateKey = selected;
    const listAll = (state.days[dateKey] || []).slice().sort((a,b)=> a.createdAt - b.createdAt);
    const list = mode==='all' ? listAll : listAll.filter(x=> x.kind === mode);
    if(list.length === 0){ toast('لا توجد بيانات للطباعة في هذا اليوم'); return; }

    const ttlIn = listAll.filter(x=>x.kind==='in').reduce((s,x)=>s + Number(x.amount||0),0);
    const ttlOut = listAll.filter(x=>x.kind==='out').reduce((s,x)=>s + Number(x.amount||0),0);
    const netAll = ttlIn - ttlOut;
    const label = mode==='all' ? 'تقرير اليوم (الكل)' : (mode==='in' ? 'تقرير واردات اليوم' : 'تقرير صادرات اليوم');
    const oldTitle = document.title;
    document.title = `${label} - ${dateKey}`;

    const attUrlsForPrint = [];
    const rows = (await Promise.all(list.map(async (it, idx)=>{
      const rowNo = idx+1;
      const ids = it.attachments || [];
      const thumbs = [];
      for(const aid of ids){
        try{
          const blob = await getAttachment(aid);
          if(!blob) continue;
          const url = URL.createObjectURL(blob);
          attUrlsForPrint.push(url);
          thumbs.push(`<div class="p-thumb"><img src="${url}" alt="مرفق ${rowNo}"><span>#${rowNo}</span></div>`);
        }catch{}
      }
      const attCell = thumbs.length ? `<div class="p-cell-att">${thumbs.join('')}</div>` : '—';
      return `
        <tr>
          <td>${rowNo}</td>
          ${mode==='all' ? `<td>${it.kind==='in'?'وارد':'صادر'}</td>` : ``}
          <td>${escapeHtml(it.time || '--:--')}</td>
          <td>${escapeHtml(it.title || '')}</td>
          <td>${escapeHtml(it.note || '')}</td>
          <td style="text-align:left">${numFmt.format(Number(it.amount||0))} ${currency}</td>
          <td>${attCell}</td>
        </tr>
      `;
    }))).join('');

    const sumMode = list.reduce((s,x)=> s + Number(x.amount||0), 0);
    const tableCols = (mode==='all' ? 7 : 6);

    printContainer.innerHTML = `
      <div class="report">
        <div class="head">
          <div>
            <h2>محل الأثاث</h2>
            <h3>${label}</h3>
            <div class="meta">التاريخ: ${dateKey} — ${weekdayName(fromKey(dateKey))}</div>
          </div>
          <div class="meta">
            <div>تم الإنشاء: ${new Date().toLocaleString('ar-JO')}</div>
            <div>العملة: ${currency}</div>
          </div>
        </div>

        <div class="chips">
          <span class="chip">إجمالي واردات اليوم: <strong>${numFmt.format(ttlIn)}</strong> ${currency}</span>
          <span class="chip">إجمالي صادرات اليوم: <strong>${numFmt.format(ttlOut)}</strong> ${currency}</span>
          <span class="chip">صافي اليوم: <strong>${numFmt.format(netAll)}</strong> ${currency}</span>
          ${mode!=='all' ? `<span class="chip">إجمالي ${mode==='in'?'الواردات':'الصادرات'} في التقرير: <strong>${numFmt.format(sumMode)}</strong> ${currency}</span>` : ``}
        </div>

        <table class="print-table" aria-label="جدول تقرير ${label}">
          <thead>
            <tr>
              <th>#</th>
              ${mode==='all' ? '<th>النوع</th>' : ''}
              <th>الوقت</th>
              <th>العنصر/الشخص</th>
              <th>ملاحظة</th>
              <th>المبلغ</th>
              <th>المرفقات</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
          <tfoot>
            <tr>
              <th colspan="${tableCols-1}" style="text-align:start">الإجمالي</th>
              <th style="text-align:left">${numFmt.format(sumMode)} ${currency}</th>
            </tr>
          </tfoot>
        </table>

        <div class="foot">
          <div class="sig">مسؤول الصندوق</div>
          <div class="sig">الإدارة</div>
        </div>
      </div>
    `;

    const imgs = Array.from(printContainer.querySelectorAll('img'));
    if(imgs.length){
      try{
        await Promise.all(imgs.map(img => img.decode ? img.decode().catch(()=>{}) : new Promise(r=>{ img.onload=img.onerror=()=>r(); })));
      }catch{}
    }

    const after = ()=>{
      document.title = oldTitle;
      attUrlsForPrint.forEach(u=> URL.revokeObjectURL(u));
      window.removeEventListener('afterprint', after);
    };
    window.addEventListener('afterprint', after);
    setTimeout(()=> window.print(), 20);
  }

  // استعراض المرفقات
  let attTempUrls = [];
  async function openAttachments(ids){
    attBody.innerHTML=''; attTempUrls.forEach(u=> URL.revokeObjectURL(u)); attTempUrls=[];
    if(!ids.length){ toast('لا توجد مرفقات'); return; }
    for(const id of ids){
      try{
        const blob = await getAttachment(id);
        if(!blob) continue;
        const url = URL.createObjectURL(blob);
        attTempUrls.push(url);
        const a = document.createElement('a');
        a.href = url; a.target = '_blank'; a.rel="noopener";
        a.innerHTML = `<img src="${url}" alt="مرفق" style="width:140px;height:140px;object-fit:cover;border:1px solid var(--border);border-radius:8px" />`;
        attBody.appendChild(a);
      }catch{}
    }
    attDialog.showModal();
  }
  attClose?.addEventListener('click', ()=>{
    attDialog.close();
    attTempUrls.forEach(u=> URL.revokeObjectURL(u));
    attTempUrls=[];
  });

  // ***************** الكاميرا: ماسح المستند *****************
  let camStream = null;
  let currentDeviceId = null;
  let useMode = 'auto'; // auto|color|bw
  let rotateSteps = 0;
  let captureTarget = 'add'; // 'add' أو 'edit' (من أي زر فتحنا الكاميرا)

  function setModeBtn(active){
    [modeAuto, modeColor, modeBW].forEach(b=> b.classList.remove('active'));
    if(active==='auto') modeAuto.classList.add('active');
    if(active==='color') modeColor.classList.add('active');
    if(active==='bw') modeBW.classList.add('active');
    useMode = active;
  }
  modeAuto?.addEventListener('click', ()=> setModeBtn('auto'));
  modeColor?.addEventListener('click', ()=> setModeBtn('color'));
  modeBW?.addEventListener('click', ()=> setModeBtn('bw'));

  rotateBtn?.addEventListener('click', ()=>{
    rotateSteps = (rotateSteps + 1) % 4;
    toast('تم التدوير');
  });

  camBtn?.addEventListener('click', ()=> openCamera('add'));
  editCamBtn?.addEventListener('click', ()=> openCamera('edit'));

  async function openCamera(target){
    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
      toast('الكاميرا غير مدعومة في هذا المتصفح');
      return;
    }
    captureTarget = target;
    rotateSteps = 0;
    setModeBtn('auto');

    await startStream();
    camCanvas.style.display='none';
    camVideo.style.display='block';
    shootBtn.style.display='';
    retakeBtn.style.display='none';
    usePhotoBtn.style.display='none';
    try{ cameraDialog.showModal(); }catch{ /*Safari قد يرفض بدون gesture*/ }
  }

  async function startStream(deviceId){
    stopStream();
    const constraints = {
      video: deviceId ? { deviceId: { exact: deviceId } } : {
        facingMode: { ideal:'environment' },
        width: { ideal:1920 }, height: { ideal:1080 }
      },
      audio:false
    };
    try{
      camStream = await navigator.mediaDevices.getUserMedia(constraints);
      camVideo.srcObject = camStream;
      camVideo.play().catch(()=>{});
      currentDeviceId = camStream.getVideoTracks()[0].getSettings().deviceId || null;
      // عكس الفيديو إذا أمامي
      const facing = camStream.getVideoTracks()[0].getSettings().facingMode || '';
      camVideo.style.transform = (facing==='user') ? 'scaleX(-1)' : 'none';
    }catch(err){
      console.error(err);
      toast('تعذر فتح الكاميرا');
    }
  }

  function stopStream(){
    try{
      if(camStream){
        camStream.getTracks().forEach(t=> t.stop());
        camStream = null;
      }
    }catch{}
  }

  // تبديل الكاميرا
  flipBtn?.addEventListener('click', async ()=>{
    try{
      const list = await navigator.mediaDevices.enumerateDevices();
      const cams = list.filter(d=> d.kind==='videoinput');
      if(!cams.length){ toast('لا توجد كاميرات أخرى'); return; }
      if(!currentDeviceId){
        await startStream(cams[0].deviceId);
        return;
      }
      const idx = cams.findIndex(c=> c.deviceId===currentDeviceId);
      const next = cams[(idx+1)%cams.length];
      await startStream(next.deviceId);
    }catch(err){
      console.error(err); toast('تعذر التبديل');
    }
  });

  // الفلاش / التورش (تبع الهاتف) إن مدعوم
  let torchOn = false;
  torchBtn?.addEventListener('click', async ()=>{
    try{
      if(!camStream){ toast('افتح الكاميرا أولاً'); return; }
      const track = camStream.getVideoTracks()[0];
      const capabilities = track.getCapabilities ? track.getCapabilities() : {};
      if(!('torch' in capabilities)){ toast('الفلاش غير مدعوم على هذه الكاميرا'); return; }
      torchOn = !torchOn;
      await track.applyConstraints({ advanced:[{ torch: torchOn }] });
      toast(torchOn ? 'تم تشغيل الإضاءة' : 'تم إيقاف الإضاءة');
    }catch(err){
      console.error(err);
      toast('تعذر التحكم بالإضاءة');
    }
  });

  // التقاط
  shootBtn?.addEventListener('click', ()=>{
    if(!camStream){ toast('الكاميرا غير مفعّلة'); return; }
    const track = camStream.getVideoTracks()[0];
    const settings = track.getSettings();
    const vw = camVideo.videoWidth || settings.width || 1280;
    const vh = camVideo.videoHeight || settings.height || 720;

    // نزّل الدقة إلى حد أقصى مناسب للمعالجة
    const maxSide = 1600;
    const scale = Math.min(1, maxSide / Math.max(vw, vh));
    camCanvas.width = Math.round(vw * scale);
    camCanvas.height = Math.round(vh * scale);
    const ctx = camCanvas.getContext('2d');
    // إذا الكاميرا أمامية وكانت مقلوبة، عدّل الرسم
    const facing = settings.facingMode || '';
    ctx.save();
    if(facing==='user'){
      ctx.translate(camCanvas.width, 0);
      ctx.scale(-1, 1);
    }
    ctx.drawImage(camVideo, 0, 0, camCanvas.width, camCanvas.height);
    ctx.restore();

    // تحسين
    enhanceCanvas(camCanvas, useMode, rotateSteps);

    camVideo.style.display='none';
    camCanvas.style.display='block';
    shootBtn.style.display='none';
    retakeBtn.style.display='';
    usePhotoBtn.style.display='';
  });

  // إعادة التصوير
  retakeBtn?.addEventListener('click', ()=>{
    camCanvas.style.display='none';
    camVideo.style.display='block';
    shootBtn.style.display='';
    retakeBtn.style.display='none';
    usePhotoBtn.style.display='none';
  });

  // استخدام الصورة
  usePhotoBtn?.addEventListener('click', async ()=>{
    try{
      const blob = await new Promise(r=> camCanvas.toBlob(b=> r(b), 'image/jpeg', 0.9));
      const finalBlob = await compressImage(blob, 1600, 0.9);
      const url = URL.createObjectURL(finalBlob);

      if(captureTarget==='add'){
        const idx = pendingAtt.length;
        pendingAtt.push({blob: finalBlob, url});
        addThumb(url, filesPreview, ()=>{
          try{ URL.revokeObjectURL(pendingAtt[idx]?.url); }catch{}
          pendingAtt[idx] = null;
        });
        pendingAtt = pendingAtt.filter(Boolean);
      } else {
        const idx = editPendingAtt.length;
        editPendingAtt.push({blob: finalBlob, url});
        addThumb(url, editFilesPreview, ()=>{
          try{ URL.revokeObjectURL(editPendingAtt[idx]?.url); }catch{}
          editPendingAtt[idx] = null;
        });
        editPendingAtt = editPendingAtt.filter(Boolean);
      }

      toast('تم التقاط الصورة');
      closeCameraDialog();
    }catch(err){
      console.error(err);
      toast('تعذر حفظ الصورة');
    }
  });

  // إغلاق
  function closeCameraDialog(){
    stopStream();
    cameraDialog.close();
    camCanvas.style.display='none';
    camVideo.style.display='block';
    shootBtn.style.display='';
    retakeBtn.style.display='none';
    usePhotoBtn.style.display='none';
    rotateSteps = 0;
    torchOn = false;
  }
  closeCamBtn?.addEventListener('click', closeCameraDialog);
  cameraDialog?.addEventListener('close', ()=> stopStream());

  // تشغيل أولي
  (function boot(){
    selected = toKey(new Date());
    initDateControls();
    renderDay(selected);
    renderHistory();
    if(!('indexedDB' in window)){
      filesInput?.setAttribute('disabled','');
      ocrBtn?.setAttribute('disabled','');
      editFiles?.setAttribute('disabled','');
    }
    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
      camBtn?.setAttribute('disabled','');
      editCamBtn?.setAttribute('disabled','');
    }
  })();

})();
</script>
</body>
</html>
